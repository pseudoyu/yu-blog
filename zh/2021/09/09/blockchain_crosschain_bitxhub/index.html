<!doctype html><html lang=zh itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.105.0"><meta charset=utf-8><title>BitXHub 跨链插件（Fabric）源码解读 · Pseudoyu</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async defer data-website-id=058488c2-18d4-498a-b683-0a898b3f6c7a src=https://data.pseudoyu.com/pseudoyu.js></script>
<script async src=https://cdn.splitbee.io/sb.js></script>
<script src=https://cdn.splitbee.io/sb-ab.js></script><meta name=description content="前言 之前提到过趣链科技的 BitXHub 跨链平台是业界较为完善的跨链开源解决方案，主要通过中继链、网关和插件机制对跨链流程中的功能、安全性和灵活性等进行了"><meta name=keywords content="hugo,blockchain,programming"><link rel=canonical href=https://www.pseudoyu.com/zh/2021/09/09/blockchain_crosschain_bitxhub/><link rel=alternate href=https://www.pseudoyu.com/en/2021/09/09/blockchain_crosschain_bitxhub/ hreflang=en><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://www.pseudoyu.com/css/den.css><link rel=stylesheet href=https://www.pseudoyu.com/css/custom.css><meta property="og:title" content="BitXHub 跨链插件（Fabric）源码解读"><meta property="og:description" content="前言 之前提到过趣链科技的 BitXHub 跨链平台是业界较为完善的跨链开源解决方案，主要通过中继链、网关和插件机制对跨链流程中的功能、安全性和灵活性等进行了"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/zh/2021/09/09/blockchain_crosschain_bitxhub/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-09T15:14:26+08:00"><meta property="article:modified_time" content="2021-09-09T15:14:26+08:00"><meta itemprop=name content="BitXHub 跨链插件（Fabric）源码解读"><meta itemprop=description content="前言 之前提到过趣链科技的 BitXHub 跨链平台是业界较为完善的跨链开源解决方案，主要通过中继链、网关和插件机制对跨链流程中的功能、安全性和灵活性等进行了"><meta itemprop=datePublished content="2021-09-09T15:14:26+08:00"><meta itemprop=dateModified content="2021-09-09T15:14:26+08:00"><meta itemprop=wordCount content="3020"><meta itemprop=keywords content="blockchain,crosschain,bitxhub,hyperledger fabric,go,"><meta name=twitter:card content="summary"><meta name=twitter:title content="BitXHub 跨链插件（Fabric）源码解读"><meta name=twitter:description content="前言 之前提到过趣链科技的 BitXHub 跨链平台是业界较为完善的跨链开源解决方案，主要通过中继链、网关和插件机制对跨链流程中的功能、安全性和灵活性等进行了"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.pseudoyu.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.pseudoyu.com/zh/><img class="mr20 header-logo-image" src=https://www.pseudoyu.com/images/fly.png alt=logo>
Pseudoyu</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/category/ideas/>思考</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/category/tools/>工具</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/category/develop/>编程</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/links/>友链</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/about/>关于</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/search/>搜索</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/><i class="fas fa-globe"></i> English</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>BitXHub 跨链插件（Fabric）源码解读</h1><p class=header-date>作者:
pseudoyu
| <span>3020 字, 7 分钟</span>
| <span data-cusdis-count-page-id=bbe6e1ce19ca5a738ab83f7b97fab32e>0</span> 评论
| 2021-09-09
| 分类:
<a href=https://www.pseudoyu.com/zh/category/develop/>Develop</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.pseudoyu.com/zh/tag/bitxhub/>bitxhub</a>,
<a href=https://www.pseudoyu.com/zh/tag/blockchain/>blockchain</a>,
<a href=https://www.pseudoyu.com/zh/tag/crosschain/>crosschain</a>,
<a href=https://www.pseudoyu.com/zh/tag/go/>go</a>,
<a href=https://www.pseudoyu.com/zh/tag/hyperledger-fabric/>hyperledger fabric</a></p><div class=clearfix></div><p class="float-right translations"><i class="fas fa-language" aria-hidden=true></i>
翻译:
<a href=https://www.pseudoyu.com/en/2021/09/09/blockchain_crosschain_bitxhub/>EN</a></p></div></div></div></div></div><main><div class="container content"><articl data-pagefind-body><h2 id=前言>前言</h2><p>之前提到过趣链科技的 BitXHub 跨链平台是业界较为完善的跨链开源解决方案，主要通过中继链、网关和插件机制对跨链流程中的功能、安全性和灵活性等进行了优化。</p><p>目前公司团队在做一个 BaaS 平台的跨链模块，我在其中负责跨链适配器部分，对应 BitXHub 平台就是监听模块和应用链插件模块。适配器将对应用链上的跨链事件作监听，并将相应参数传给网关作跨链相关的业务逻辑需求。</p><p>因此，打算对 BitXHub 的 <a href=https://github.com/meshplus/pier-client-fabric>meshplus/pier-client-fabric</a> 插件源码作深入解读，学习其优秀的代码结构和功能模块，以便更好地实现自己的适配器功能。</p><h2 id=跨链交易流程>跨链交易流程</h2><p><img src=https://image.pseudoyu.com/images/cross_chain_plugin.png alt=cross_chain_plugin></p><p>根据跨链业务需求，典型的跨链调用流程如上图所示。</p><ol><li>需要进行跨链交易的子链需要安装适配器并部署提供的跨链合约和业务合约</li><li>用户通过 SDK 调用业务合约时，合约将调用跨链合约并抛出跨链事件</li><li>子链相应适配器将会轮询或订阅跨链合约抛出的跨链事件并发送到跨链网关的监听模块</li><li>跨链网关将从跨链事件中提取的响应方法和参数转换为目标子链可识别的交易</li><li>跨链网关将转换后的交易提交到目标子链并执行</li></ol><h2 id=适配器机制>适配器机制</h2><h3 id=接口设计>接口设计</h3><p>适配器主要负责与子链之间的交互，并以接口调用的方式参与跨链交互。主要提供以下接口。</p><h4 id=调用链码>调用链码</h4><p>适配器接收跨链网关发送的交易参数，封装为已适配子链接受的数据结构并调用链码。</p><h4 id=查询跨链交易>查询跨链交易</h4><p>子链将跨链相关细节存在 payload 字段中，如合约、用户等，适配器对这些信息进行解析与封装，提供相应接口给跨链网关查询。</p><h4 id=查询历史交易信息>查询历史交易信息</h4><p>适配器需要提供历史交易查询接口，以便于当跨链事件因网络传输等原因未收到时主动进行查询。</p><h4 id=查询应用链基本信息>查询应用链基本信息</h4><p>适配器需要提供其所适配子链相关信息的查询接口以便于跨链网关进行查询，如名称、类型等。</p><h2 id=源码解读>源码解读</h2><p>接下来将对 BitXHub 跨链插件（Fabric）的核心功能模块源码进行解读。</p><h3 id=设计模式>设计模式</h3><p>插件项目采用的是典型的“生产者-消费者”模型，很适合这样需要轮询/订阅接收数据的并发场景。这种模型用到了任意时刻只有一个 goroutine 对 channel 中的某一个数据进行访问的特性。</p><h4 id=订阅轮询跨链事件>订阅/轮询跨链事件</h4><p>插件需要构建一个生产者对象来订阅自己相应子链的跨链事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 构造生产者
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>event</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>channelProvider</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nf>WithBlockEvents</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to create fabcli, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=p>.</span><span class=nx>eventClient</span> <span class=p>=</span> <span class=nx>ec</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 订阅跨链事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>registration</span><span class=p>,</span> <span class=nx>notifier</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ec</span><span class=p>.</span><span class=nf>RegisterChaincodeEvent</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>CCID</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>EventFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to register chaincode event, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=p>.</span><span class=nx>registration</span> <span class=p>=</span> <span class=nx>registration</span>
</span></span></code></pre></div><p>订阅事件的方法是调用了 <code>fabric-sdk-go</code> 的 <code>RegisterChaincodeEvent()</code> 方法，需要注意的是，当不需要监听事件时，需要调用 <code>Unregister()</code> 方法来取消订阅。</p><p>方法中的 <code>ccID</code> 是需要监听的链码 ID，<code>eventFilter</code> 是需要监听的链码时间，而这个方法会返回一个 channel 接收数据（当取消订阅时，channel 会关闭）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>RegisterChaincodeEvent</span><span class=p>(</span><span class=nx>ccID</span><span class=p>,</span> <span class=nx>eventFilter</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>fab</span><span class=p>.</span><span class=nx>Registration</span><span class=p>,</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>fab</span><span class=p>.</span><span class=nx>CCEvent</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>eventService</span><span class=p>.</span><span class=nf>RegisterChaincodeEvent</span><span class=p>(</span><span class=nx>ccID</span><span class=p>,</span> <span class=nx>eventFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>将订阅了跨链合约的对象（即生产者）与消费者都置于无限循环中，当有跨链事件抛出时，生产者将会不断地向 channel 中放入数据，而消费者也不断从通道中取出数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 生产者将跨链事件写入通道
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=nx>ccEvent</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>notifier</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>ccEvent</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>c</span><span class=p>.</span><span class=nf>handle</span><span class=p>(</span><span class=nx>ccEvent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 消费者从通道中取出跨链事件数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span></code></pre></div><p>因为生产者和消费者都在无限循环中，生产者的 goroutine 不会退出，channel 持续写入数据，而当没有新事件时，消费者将会阻塞，等待生产者接收新的数据并写入 channel。</p><h3 id=插件初始化运行与关闭>插件初始化、运行与关闭</h3><p>看了整体的设计模式，我们从程序的主入口看看整个插件项目运行的机制。</p><h4 id=初始化>初始化</h4><p>在 client 程序初始化中，首先根据自定义的结构构造了消费者对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 构造消费者
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>mgh</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newFabricHandler</span><span class=p>(</span><span class=nx>contractmeta</span><span class=p>.</span><span class=nx>EventFilter</span><span class=p>,</span> <span class=nx>eventC</span><span class=p>,</span> <span class=nx>appchainID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>done</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>csm</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>NewConsumer</span><span class=p>(</span><span class=nx>configPath</span><span class=p>,</span> <span class=nx>contractmeta</span><span class=p>,</span> <span class=nx>mgh</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=运行>运行</h4><p>程序运行的入口很简单，就是对跨链合约进行轮询，并启动消费者对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>Start</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Fabric consumer started&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>c</span><span class=p>.</span><span class=nf>polling</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=关闭>关闭</h4><p>关闭插件也很简单，即停止程序运行并取消订阅事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 关闭插件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>Stop</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>ticker</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>done</span> <span class=o>&lt;-</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 consumer 包中取消订阅事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span> <span class=nf>Shutdown</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>eventClient</span><span class=p>.</span><span class=nf>Unregister</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>registration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>再深一层看，取消订阅事件是调用了 <code>fabric-sdk-go</code> 的 <code>Unregister()</code> 方法，会取消该事件的订阅并关闭相应通道。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>Unregister</span><span class=p>(</span><span class=nx>reg</span> <span class=nx>fab</span><span class=p>.</span><span class=nx>Registration</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>eventService</span><span class=p>.</span><span class=nf>Unregister</span><span class=p>(</span><span class=nx>reg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=接口实现>接口实现</h3><p>除了对事件进行订阅监听外，插件还提供了一系列查询接口供网关调用，以完成相应跨链操作。</p><h4 id=getproof>getProof()</h4><p>如获取 Proof 信息等</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>getProof</span><span class=p>(</span><span class=nx>response</span> <span class=nx>channel</span><span class=p>.</span><span class=nx>Response</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>proof</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>handle</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>response</span> <span class=nx>channel</span><span class=p>.</span><span class=nx>Response</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// query proof from fabric
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>l</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ledger</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nx>channelProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>QueryTransaction</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>TransactionID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>pd</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>common</span><span class=p>.</span><span class=nx>Payload</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>TransactionEnvelope</span><span class=p>.</span><span class=nx>Payload</span><span class=p>,</span> <span class=nx>pd</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>pt</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>peer</span><span class=p>.</span><span class=nx>Transaction</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>pd</span><span class=p>.</span><span class=nx>Data</span><span class=p>,</span> <span class=nx>pt</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>pt</span><span class=p>.</span><span class=nx>Actions</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Payload</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>retry</span><span class=p>.</span><span class=nf>Retry</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>attempt</span> <span class=kt>uint</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>		<span class=nx>proof</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Can&#39;t get proof&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=nx>strategy</span><span class=p>.</span><span class=nf>Wait</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Can&#39;t get proof&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>proof</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=getchainid>getChainID()</h4><p>该接口用于获取链的 ID</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>GetChainID</span><span class=p>()</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>request</span> <span class=o>:=</span> <span class=nx>channel</span><span class=p>.</span><span class=nx>Request</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ChaincodeID</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>CCID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Fcn</span><span class=p>:</span>         <span class=nx>GetChainId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nx>ChannelClient</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Payload</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>chainIds</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>Payload</span><span class=p>),</span> <span class=s>&#34;-&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>chainIds</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>chainIds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>chainIds</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=其他接口>其他接口</h4><p>其他更多接口实现细节详见 <a href=https://github.com/meshplus/pier-client-fabric/blob/master/client.go>meshplus/pier-client-fabric/client.go</a>。</p><h3 id=跨链合约>跨链合约</h3><p>跨链合约是实现插件监听的重要部分，当业务需要跨链时，将会统一调用跨链合约，并与跨链网关进行交互。</p><p>跨链合约提供了一系列接口供业务合约进行实现，因此按照一定的规范撰写业务合约则能简化跨链业务的开发和维护，跨链合约编写的规范详见&lt;<a href=https://github.com/meshplus/bitxhub/wiki/%E8%B7%A8%E9%93%BE%E5%90%88%E7%BA%A6%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3>跨链合约编写文档</a>>。</p><h4 id=事件实现>事件实现</h4><p>跨链合约是怎样将跨链事件抛出给插件的呢？</p><p>在跨链合约的 <code>Invoke()</code> 方法中，跨链合约首先通过 <code>GetFunctionAndParameters()</code> 方法获取了合约调用者（也就是业务合约）的调用方法和相应参数，然后通过对方法名进行判断，从而调用不同的合约。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>broker</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>Invoke</span><span class=p>(</span><span class=nx>stub</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>ChaincodeStubInterface</span><span class=p>)</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>function</span><span class=p>,</span> <span class=nx>args</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>GetFunctionAndParameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=k>switch</span> <span class=nx>function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>case</span> <span class=s>&#34;getChainId&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getChainId</span><span class=p>(</span><span class=nx>stub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s>&#34;getInMessage&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getInMessage</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s>&#34;getOutMessage&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getOutMessage</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>case</span> <span class=s>&#34;EmitInterchainEvent&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>EmitInterchainEvent</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;invalid function: &#34;</span> <span class=o>+</span> <span class=nx>function</span> <span class=o>+</span> <span class=s>&#34;, args: &#34;</span> <span class=o>+</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;,&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们着重来分析一下当调用了 <code>EmitInterchainEvent()</code> 时，跨链合约做了什么，相应说明见注释。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>broker</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>EmitInterchainEvent</span><span class=p>(</span><span class=nx>stub</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>ChaincodeStubInterface</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 判断传入参数数量是否正确
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 跨链合约需要传入很多参数，如调用失败在链上容易产生安全问题
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>5</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;incorrect number of arguments, expecting 7&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取参数并存入相应变量
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 目标链 ID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dstServiceID</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 自己的链码 ID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cid</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getChaincodeID</span><span class=p>(</span><span class=nx>stub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 bxhID 和 appchainID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>curFullID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>genFullServiceID</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>cid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 将当前链 ID 和目标链 ID 组合成输出跨链服务组
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>outServicePair</span> <span class=o>:=</span> <span class=nf>genServicePair</span><span class=p>(</span><span class=nx>curFullID</span><span class=p>,</span> <span class=nx>dstServiceID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取输出值的键值对
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>outMeta</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getMap</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>outterMeta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 查询输出跨链服务组是否在键值对中，否则设为 0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>]</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 封装交易信息
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tx</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Event</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Index</span><span class=p>:</span>     <span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>DstFullID</span><span class=p>:</span> <span class=nx>dstServiceID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>SrcFullID</span><span class=p>:</span> <span class=nx>curFullID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Func</span><span class=p>:</span>      <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>Args</span><span class=p>:</span>      <span class=nx>args</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>Argscb</span><span class=p>:</span>    <span class=nx>args</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>Argsrb</span><span class=p>:</span>    <span class=nx>args</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 输出服务自增
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>]</span><span class=o>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 将交易信息转为 json 格式
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>txValue</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 将输出事件消息格式化
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>key</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>outMsgKey</span><span class=p>(</span><span class=nx>outServicePair</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>FormatUint</span><span class=p>(</span><span class=nx>tx</span><span class=p>.</span><span class=nx>Index</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 将消息与交易信息写入账本（持久化）
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>PutState</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>txValue</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;persist event: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 设定相应跨链交易事件名称，并将交易信息存入 payload 中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>SetEvent</span><span class=p>(</span><span class=nx>interchainEventName</span><span class=p>,</span> <span class=nx>txValue</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;set event: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 将元数据状态写入账本
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>putMap</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>outterMeta</span><span class=p>,</span> <span class=nx>outMeta</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Success</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>以上就是调用跨链合约时所做的，本质上其实只是在跨链合约中通过 <code>SetEvent()</code> 设置了一个触发一个事件，再在插件中通过 <code>RegisterChaincodeEvent()</code> 进行订阅监听。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nf>SetEvent</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>payload</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>error</span>
</span></span></code></pre></div><p><code>SetEvent()</code> 是 <code>shim</code> 包下的一个接口，主要传入名称与 payload 数组，关于链码事件监听原理与细节详见 &lt;<a href=https://www.pseudoyu.com/zh/2021/09/01/blockchain_hyperledger_fabric_gosdk_event/>Hyperledger Fabric Go SDK 事件分析</a>>。</p><h3 id=业务合约>业务合约</h3><p>分析完了跨链合约，我们来看看业务合约是如何调用跨链合约的呢，以示例中的 <code>data_swapper.go</code> 数据交换合约为例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>DataSwapper</span><span class=p>)</span> <span class=nf>get</span><span class=p>(</span><span class=nx>stub</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>ChaincodeStubInterface</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// args[0]: key
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>value</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>GetState</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Success</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// args[0]: destination service id
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// args[1]: key
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>ToChaincodeArgs</span><span class=p>(</span><span class=nx>emitInterchainEventFunc</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&#34;interchainGet,interchainSet,&#34;</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>response</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>InvokeChaincode</span><span class=p>(</span><span class=nx>brokerContractName</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>channelID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Status</span> <span class=o>!=</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>OK</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invoke broker chaincode %s error: %s&#34;</span><span class=p>,</span> <span class=nx>brokerContractName</span><span class=p>,</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Message</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Success</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;incorrect number of arguments&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如想在 <code>data_swapper.go</code> 业务合约中获取其他链的信息，通过 <code>switch...case...</code> 在调用 <code>get</code> 方法时首先对输入参数数组 <code>args []string</code> 的长度进行判断，当长度为 1 时，正常调用自身合约进行查询，而当长度为 2 时，首先通过 fabric 提供的 <code>ToChaincodeArgs()</code> 方法将参数从 <code>string</code> 转为链码参数数组格式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ToChaincodeArgs</span><span class=p>(</span><span class=nx>args</span> <span class=o>...</span><span class=kt>string</span><span class=p>)</span> <span class=p>[][]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>bargs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>arg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>args</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>bargs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>bargs</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后直接在业务链码中通过 <code>InvokeChaincode()</code> 方法调用跨链合约，并传入参数和通道 ID，至此就完成了一次跨链数据查询链码调用。</p><h2 id=总结>总结</h2><p>以上就是对跨链交易流程与 BitXHub 跨链插件（Fabric）源码解读，也希望在此过程中加深对跨链机制和相关平台的理解，未来能更好地参与到其开源建设中。</p><h2 id=参考资料>参考资料</h2><blockquote><ol><li><a href=https://github.com/gocn/opentalk/tree/main/PhaseTen_BitXHub>跨链技术平台 BitXHub</a></li><li><a href=https://meshplus.github.io/bitxhub/bitxhub/introduction/summary/>BitXHub Document</a></li><li><a href=https://github.com/meshplus/pier-client-fabric>meshplus/pier-client-fabric</a></li><li><a href=https://tech.hyperchain.cn/bitxhub-design-thinking/>十问 BitXHub:谈谈跨链平台的架构设计</a></li><li><a href=https://github.com/meshplus/bitxhub/wiki/%E8%B7%A8%E9%93%BE%E5%90%88%E7%BA%A6%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3>跨链合约编写文档</a></li><li><a href=https://www.pseudoyu.com/zh/2021/09/01/blockchain_hyperledger_fabric_gosdk_event/>Hyperledger Fabric Go SDK 事件分析</a></li></ol></blockquote></articl><h2>相关文章</h2><dl class=row></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-02-10</dt><dd class=col-md-9><a href=/zh/2023/02/10/cosmos_introduction_and_explaination/>Cosmos 区块链架构与 Tendermint 共识机制</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2021-09-07</dt><dd class=col-md-9><a href=/zh/2021/09/07/blockchain_baas_platform/>区块链服务平台（BaaS）简介及架构</a></dd></dl><dt class=col-md-3>2021-09-06</dt><dd class=col-md-9><a href=/zh/2021/09/06/blockchain_crosschain/>跨链技术原理与实战</a></dd></dl></dl></dl></dl><dt class=col-md-3>2021-09-01</dt><dd class=col-md-9><a href=/zh/2021/09/01/blockchain_hyperledger_fabric_gosdk_event/>Hyperledger Fabric Go SDK 事件分析</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2021-03-23</dt><dd class=col-md-9><a href=/zh/2021/03/23/blockchain_hyperledger_fabric_network/>Hyperledger Fabric 网络与安全体系浅析</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://www.pseudoyu.com><img src=/images/author.webp alt=pseudoyu></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>pseudoyu</p><p class=author-desc>后端 & 智能合约研发工程师，HKU ECICer。喜欢探索新技术，空闲时也折腾 Logseq 等效率工具。 在 <a href=https://github.com/pseudoyu>GitHub</a> 关注我。在我的 <a href=https://t.me/pseudoyulife>Telegram 频道</a>了解更多。</p></div></div></div><div align=center><div class=comment-underline></div></div><br><div id=cusdis_thread data-host=https://comments.pseudoyu.com data-app-id=27a61667-fd43-4a0d-934d-f45b944489ee data-page-id=bbe6e1ce19ca5a738ab83f7b97fab32e data-page-url=https://www.pseudoyu.com/zh/2021/09/09/blockchain_crosschain_bitxhub/ data-page-title="BitXHub 跨链插件（Fabric）源码解读"></div><script defer src=https://comments.pseudoyu.com/js/widget/lang/zh-cn.js></script>
<script async defer src=https://comments.pseudoyu.com/js/cusdis.es.js></script>
<script defer data-host=https://comments.pseudoyu.com data-app-id=27a61667-fd43-4a0d-934d-f45b944489ee src=https://comments.pseudoyu.com/js/cusdis-count.umd.js></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://www.pseudoyu.com/zh/tags/>标签</a></li><li><a href=https://www.pseudoyu.com/zh/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://www.pseudoyu.com/zh/index.xml><i class="fas fa-rss-square"></i> RSS</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社交</div><ul class=list-unstyled><li><a href=https://t.me/pseudoyulife rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/pseudo_yu rel=noopener target=_blank>Twitter</a></li><li><a href=https://www.instagram.com/pseudo.yu/ rel=noopener target=_blank>Instagram</a></li><li><a href=https://space.bilibili.com/5374948/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>关于</div><ul class=list-unstyled><li><a href=https://github.com/pseudoyu rel=noopener target=_blank>Yu's GitHub</a></li><li><a href=https://uptime.pseudoyu.com/status/services rel=noopener target=_blank>Yu's Services</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em><a href=https://data.pseudoyu.com/share/8YKX7FUa/pseudoyu-blog rel=noopener target=_blank>Yu's blog analytics</a></em></small><br><small><em>Powered by <a href=https://gohugo.io rel=noopener target=_blank>Hugo</a> - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>den</a></em></small><br><small><em><a href=https://www.hku.hk rel=noopener target=_blank>The University of Hong Kong</a> - <a href=https://www.cs.hku.hk rel=noopener target=_blank>CS</a></em></small><br><small>&copy;
Yu Zhang
2020 -
2023</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>