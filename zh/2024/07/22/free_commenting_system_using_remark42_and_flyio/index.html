<!doctype html><html lang=zh itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.105.0"><meta charset=utf-8><title>从零开始搭建你的免费博客评论系统（Remark42 + fly.io） · Pseudoyu</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script data-goatcounter=https://stats.pseudoyu.com/count async src=//stats.pseudoyu.com/count.js></script><meta name=description content="前言 在「2024 年了，我的博客有了什么变化」一文中，我介绍了自己使用 Serverless 平台和一些开源项目搭建的博客系统，也开启了这个系列教程来记录搭建和部署"><meta name=keywords content="hugo,blockchain,programming"><link rel=canonical href=https://www.pseudoyu.com/zh/2024/07/22/free_commenting_system_using_remark42_and_flyio/><link rel=alternate href=https://www.pseudoyu.com/en/2024/07/22/free_commenting_system_using_remark42_and_flyio/ hreflang=en><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://www.pseudoyu.com/css/den.css><link rel=stylesheet href=https://www.pseudoyu.com/css/custom.css><meta property="og:title" content="从零开始搭建你的免费博客评论系统（Remark42 + fly.io）"><meta property="og:description" content="前言 在「2024 年了，我的博客有了什么变化」一文中，我介绍了自己使用 Serverless 平台和一些开源项目搭建的博客系统，也开启了这个系列教程来记录搭建和部署"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/zh/2024/07/22/free_commenting_system_using_remark42_and_flyio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-22T01:10:42+08:00"><meta property="article:modified_time" content="2024-07-22T01:10:42+08:00"><meta itemprop=name content="从零开始搭建你的免费博客评论系统（Remark42 + fly.io）"><meta itemprop=description content="前言 在「2024 年了，我的博客有了什么变化」一文中，我介绍了自己使用 Serverless 平台和一些开源项目搭建的博客系统，也开启了这个系列教程来记录搭建和部署"><meta itemprop=datePublished content="2024-07-22T01:10:42+08:00"><meta itemprop=dateModified content="2024-07-22T01:10:42+08:00"><meta itemprop=wordCount content="4640"><meta itemprop=keywords content="commenting-system,serverless,fly.io,blog,"><meta name=twitter:card content="summary"><meta name=twitter:title content="从零开始搭建你的免费博客评论系统（Remark42 + fly.io）"><meta name=twitter:description content="前言 在「2024 年了，我的博客有了什么变化」一文中，我介绍了自己使用 Serverless 平台和一些开源项目搭建的博客系统，也开启了这个系列教程来记录搭建和部署"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.pseudoyu.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.pseudoyu.com/zh/><img class="mr20 header-logo-image" src=https://image.pseudoyu.com/images/fly.png alt=logo>
Pseudoyu</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/category/ideas/>思考</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/category/tools/>工具</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/category/develop/>编程</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/links/>友链</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/about/>关于</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/search/>搜索</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/><i class="fas fa-globe"></i> English</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>从零开始搭建你的免费博客评论系统（Remark42 + fly.io）</h1><p class=header-date>作者:
pseudoyu
| <span>4640 字, 10 分钟</span>
| <span class=remark42__counter data-url=https://www.pseudoyu.com/zh/2024/07/22/free_commenting_system_using_remark42_and_flyio/></span> 评论
| 2024-07-22
| 分类:
<a href=https://www.pseudoyu.com/zh/category/tools/>Tools</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.pseudoyu.com/zh/tag/blog/>blog</a>,
<a href=https://www.pseudoyu.com/zh/tag/commenting-system/>commenting-system</a>,
<a href=https://www.pseudoyu.com/zh/tag/fly.io/>fly.io</a>,
<a href=https://www.pseudoyu.com/zh/tag/serverless/>serverless</a></p><div class=clearfix></div><p class="float-right translations"><i class="fas fa-language" aria-hidden=true></i>
翻译:
<a href=https://www.pseudoyu.com/en/2024/07/22/free_commenting_system_using_remark42_and_flyio/>EN</a></p></div></div></div></div></div><main><div class="container content"><articl data-pagefind-body><h2 id=前言>前言</h2><p>在「<a href=https://www.pseudoyu.com/zh/2024/06/29/what_changed_in_my_blog_2024/>2024 年了，我的博客有了什么变化</a>」一文中，我介绍了自己使用 Serverless 平台和一些开源项目搭建的博客系统，也开启了这个系列教程来记录搭建和部署全过程。</p><p>本篇是关于评论系统的解决方案。</p><h2 id=评论系统迭代>评论系统迭代</h2><p><img src=https://image.pseudoyu.com/images/remark42_comments.png alt=remark42_comments></p><p>我常常觉得评论不仅仅是读者与作者之间的沟通互动，其内容本身也是文章的一部分，甚至常常有些评论的思考与观点讨论会比文章本身更有价值，所以对于评论系统一直很重视，并不愿意信任一些第三方托管的服务，不希望有什么审查，也想风格尽可能简约，并与自己的博客风格相符。</p><p>在博客发展过程中，评论系统方案也经历过几次迭代，关于评论系统的类型和选择，我很喜欢的开发者 <a href=https://reorx.com/>reorx</a> 在「<a href=https://reorx.com/blog/blog-commenting-systems/>更换博客评论系统</a>」中有详细的介绍了，我不作更多引申了，本文更重个人体验与详细的搭建过程。</p><h3 id=disqus>Disqus</h3><p>我最早使用的博客评论系统是万恶的 Disqus，一个笨重且会收集用户隐私的知名评论系统，因为加载比较慢，且免费版本经常会附带一些广告，实在难以忍受，再加上当时其实也基本上没什么评论，并没有什么迁移负担，用了没多久就直接弃用了。</p><h3 id=utterances>Utterances</h3><p>于是换成了另一个基于 GitHub issues 的评论系统 utterances，它会为每篇文章生成一个 issue，用户通过授权 GitHub 登录来对 issue 发表评论。这种方式的好处是只需要授权一个 utterances-bot 来进行管理，无需自己部署服务，维护数据库等。但是用了一段时间后，觉得有几点不足：</p><ul><li>基于 GitHub API 进行评论管理，如之后接口变动或对这类利用 issue 进行评论的方式进行限制，会不太稳定</li><li>读者必须要授权 GitHub 登录，非技术人员或使用移动端阅读的读者使用起来很不方便</li><li>会污染 GitHub 仓库的 Issues 记录，也不方便后续迁移到其他系统</li></ul><h3 id=cusdis--supabase--vercel>Cusdis + Supabase + Vercel</h3><p>Cusdis 是 <a href=https://lutaonan.com/>Randy</a> 做的一个注重数据隐私的开源的评论系统，十分轻量，经过 gzipped 后大约只有 5kb，从名字来看也知道是难以忍受 Disqus，自己做了一个替代版，因此它也是支持 Disqus 历史数据导入的，很贴心。</p><p>从 2021 年中就开始使用了，到现在整整三年了，除了最开始的时候因为 Heroku、Railway 相继收费而折腾了一下部署平台外，一直都稳稳地运行着，不过我在使用中也有遇到一些问题：</p><ul><li>大概是由于微信内置浏览器做了一些魔改，在博客从微信聊天/对话打开是看不到评论组件的</li><li>尽管可以输入邮箱，但并不支持订阅评论回复</li><li>需要管理员手动审核评论，但评论提醒的 TG Bot 时常失效而错过评论</li></ul><p>不过整体来说时至今日依然是十分值得推荐的方案，轻量，方便自部署，风格也简约好看，搭建教程参看「<a href=https://www.pseudoyu.com/zh/2022/05/24/free_and_lightweight_blog_comment_system_using_cusdis_and_railway/>轻量级开源免费博客评论系统解决方案 （Cusdis + Railway）</a>」。</p><p>鉴于 Railway 从去年 8 月起已经取消了 Free Plan，如果依然想完全免费使用，可以使用 Vercel/Netlify/Zeabur 免费部署主项目，并在 <a href=https://supabase.com>Supabase</a> 上部署一个免费的 PostgreSQL 数据库实例，把链接作为环境变量传入 Cusdis 服务中即可，其他流程大同小异。</p><p>另外因为其核心功能已经许久没有什么更新，比起其他较为成熟的评论系统也显得有些简陋，不过由于我也秉持着够用即可的原则，一直没动迁移/更新的念头，只有在其中一阵子在学前端时还参与了一些 Cusdis V2 版本的开发，不过也没做多久。</p><p>由于四月时 Vercel 部署升级的时候一直失败，导致接近几周的时间没收到评论，再加上确实有了一些功能需求，所以下定决心进行迁移，探究起了新的方案。</p><h3 id=remark42--flyio>Remark42 + fly.io</h3><p>调研了一圈后选择了 <a href=https://reorx.com/>reorx</a> 在「<a href=https://reorx.com/blog/blog-commenting-systems/>更换博客评论系统</a>」一文中最后选定的 <a href=https://remark42.com/>Remark42</a>。</p><p>单纯就配置选项来说比起 Cusdis 还是丰富了不少，目前配置了常用的几种社交账号登录（GitHub、Twitter、Telegram、邮箱）、可以匿名评论、支持邮件订阅回复提醒并且也设置了 TG bot 提醒，并且部署在 <a href=https://fly.io/>fly.io</a>，go 单二进制 + 数据库单文件，很舒服的解决方案，更详细的 Remark42 的介绍和优势可以参看上面那篇文章。</p><p>虽然 Remark42 提供了一些迁移方案，但本身并不支持我使用的 Cusdis，但好在它是用 Golang 写的，我自己添加了迁移逻辑，将这些年沉淀下来的 438 条评论数据都无缝迁移过来了。</p><h2 id=remark42--flyio-部署说明>Remark42 + fly.io 部署说明</h2><p>Remark42 + fly.io 的方案仅牵扯到单个服务，数据库使用的是 boltdb 挂载于 volume 中，但所有操作都在 fly.io 的 Free Plan 中。</p><p>下面将从零开始介绍如何搭建这个免费评论系统。</p><p>Remark42 本身代码开源 —— 「<a href=https://github.com/umputun/remark42>GitHub - umputun/remark42</a>」，并提供了官方维护的镜像，文档清晰易读，可以根据自己的实际需求进行配置。</p><h3 id=安装-flyctl-命令行工具>安装 <code>flyctl</code> 命令行工具</h3><p><a href=https://fly.io>fly.io</a> 与我之前使用的 Railway、Zeabur 等很大的一个不同点是它大部分操作基于命令行与配置文件，而不是在网页端管理后台进行操作，所以首先需要根据<a href=https://fly.io/docs/flyctl/install/>文档</a>安装 <code>flyctl</code> 命令行工具。</p><p>以 macOS 为例，我使用 <code>brew</code> 进行安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>brew install flyctl
</span></span></code></pre></div><h3 id=授权登录>授权登录</h3><p>打开终端工具，使用以下命令进行授权登录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>flyctl auth login
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/fly_auth_login.png alt=fly_auth_login></p><p><img src=https://image.pseudoyu.com/images/fly_auth_web.png alt=fly_auth_web></p><p>在 Web 端进行账户登录或新建账号，完成后点击 <code>Continue as xxx</code> 即完成 <code>flyctl</code> 命令行的授权登录。</p><h3 id=创建应用目录>创建应用目录</h3><p><img src=https://image.pseudoyu.com/images/create_fly_config.png alt=create_fly_config></p><p>由于我通常会手动进行进行配置管理，而不是用它官方的模板，所以我会新建一个类似 <code>remark42-on-fly</code> 的目录，并将所有的配置文件、环境变量等放在这个路径下。</p><p>并使用 VS Code 进行编辑（也可以使用 vim 或者其他编辑器/IDE）。</p><h3 id=配置文件>配置文件</h3><p>fly.io 主要是使用 <code>.toml</code> 格式的配置文件进行服务管理，以下是我部署的服务对应的配置文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>app</span> <span class=p>=</span> <span class=s1>&#39;yu-remark42-01&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>primary_region</span> <span class=p>=</span> <span class=s1>&#39;hkg&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>build</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>image</span> <span class=p>=</span> <span class=s1>&#39;umputun/remark42:latest&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>mounts</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>source</span> <span class=p>=</span> <span class=s1>&#39;remark42_data_01&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>destination</span> <span class=p>=</span> <span class=s1>&#39;/srv/var&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>http_service</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>internal_port</span> <span class=p>=</span> <span class=mi>8080</span>
</span></span><span class=line><span class=cl>  <span class=nx>force_https</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>auto_stop_machines</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>auto_start_machines</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>min_machines_running</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>processes</span> <span class=p>=</span> <span class=p>[</span><span class=s1>&#39;app&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>env</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>REMARK_URL</span> <span class=p>=</span> <span class=s1>&#39;https://yu-remark42-01.fly.dev/&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>SECRET</span> <span class=p>=</span> <span class=s1>&#39;remark42-secret&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>SITE</span><span class=p>=</span> <span class=s1>&#39;remark42-demo&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ADMIN_SHARED_ID</span><span class=p>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>vm</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>cpu_kind</span> <span class=p>=</span> <span class=s1>&#39;shared&#39;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cpus</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>memory_mb</span> <span class=p>=</span> <span class=mi>256</span>
</span></span></code></pre></div><p>这是详细的配置说明：</p><ul><li><code>app</code>：应用名称，这里我使用了 <code>yu-remark42-01</code>，可以根据自己的实际情况进行修改</li><li><code>primary_region</code>：部署区域，可以从这个<a href=https://fly.io/docs/reference/regions/#fly-io-regions>列表</a>中选择自己想部署的区域，我选择了香港</li><li><code>[Build]</code>，这个部分主要是服务镜像相关的配置<ul><li><code>image</code>：服务镜像，使用了官方提供的 <code>umputun/remark42:latest</code>，如有需要可以指定 tag 版本</li></ul></li><li><code>[[mounts]]</code>，这个部分主要是挂载数据卷的配置，由于 Remark42 使用 boltdb 数据库，需要持久化存储<ul><li><code>source</code>：数据卷名称，这里我使用了 <code>remark42_data_01</code></li><li><code>destination</code>：挂载目录，这里我挂载到了 <code>/srv/var</code>，这个目录是 Remark42 默认的数据存储目录</li></ul></li><li><code>[http_service]</code>，这个部分主要是服务相关的配置<ul><li><code>internal_port</code>：服务内部端口，使用 8080</li><li><code>force_https</code>：强制使用 HTTPS</li><li><code>auto_stop_machines</code>：设置为 <code>false</code></li><li><code>auto_start_machines</code>：设置为 <code>true</code>，即自动启动</li><li><code>min_machines_running</code>：最小运行机器数，设置为 1</li><li><code>processes</code>：服务进程，设置为 <code>app</code></li></ul></li><li><code>[env]</code>，配置环境变量<ul><li><code>REMARK_URL</code>：Remark42 服务的 URL，这里我使用了 <code>https://yu-remark42-demo.fly.dev/</code>，这是 fly.io 自动生成的，后续如果有了自定义域名则需要更改</li><li><code>SITE</code>：站点名称，这里我使用了 <code>remark42-demo</code></li><li><code>SECRET</code>：自定义的 JWT Token，这里我使用了 <code>remark42-secret</code></li><li><code>ADMIN_SHARED_ID</code>：管理员 ID，这里我使用了空字符串，即没有管理员，后续可以补充</li></ul></li><li><code>[[vm]]</code>，这个部分主要是机器相关的配置<ul><li><code>cpu_kind</code>：CPU 类型，设置为 <code>shared</code></li><li><code>cpus</code>：CPU 数量，设置为 1</li><li><code>memory_mb</code>：内存，设置为 256MB</li></ul></li></ul><h3 id=创建服务>创建服务</h3><p>完成并检查配置后，运行以下命令进行服务创建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>flyctl launch
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/fly_launch_remark42.png alt=fly_launch_remark42></p><h3 id=环境变量配置>环境变量配置</h3><p>目前只是部署了服务，并没有设置环境变量，因此服务启动会有问题，接下来我们设置环境变量，放在<code>prod.env</code> 文件中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>AUTH_GITHUB_CID=&lt;your_github_cid&gt;
</span></span><span class=line><span class=cl>AUTH_GITHUB_CSEC=&lt;your_github_csec&gt;
</span></span><span class=line><span class=cl>AUTH_TWITTER_CID=&lt;your_twitter_cid&gt;
</span></span><span class=line><span class=cl>AUTH_TWITTER_CSEC=&lt;your_twitter_csec&gt;
</span></span><span class=line><span class=cl>AUTH_ANON=true
</span></span><span class=line><span class=cl>AUTH_TELEGRAM=true
</span></span><span class=line><span class=cl>TELEGRAM_TOKEN=&lt;your_telegram_token&gt;
</span></span><span class=line><span class=cl>NOTIFY_ADMINS=telegram
</span></span><span class=line><span class=cl>NOTIFY_TELEGRAM_CHAN=&lt;your_telegram_group&gt;
</span></span><span class=line><span class=cl>NOTIFY_USERS=email
</span></span><span class=line><span class=cl>AUTH_EMAIL_ENABLE=true
</span></span><span class=line><span class=cl>SMTP_HOST=smtp.gmail.com
</span></span><span class=line><span class=cl>SMTP_PORT=465
</span></span><span class=line><span class=cl>SMTP_TLS=true
</span></span><span class=line><span class=cl>SMTP_USERNAME=xxx@gmail.com
</span></span><span class=line><span class=cl>SMTP_PASSWORD=&lt;your_password&gt;
</span></span><span class=line><span class=cl>AUTH_EMAIL_FROM=xxx@gmail.com
</span></span><span class=line><span class=cl>NOTIFY_EMAIL_FROM=xxx@gmail.com
</span></span></code></pre></div><p>环境变量的部分相对比较复杂，具体参数参看<a href=https://remark42.com/docs/configuration/authorization/>文档</a>。</p><h4 id=登录授权配置>登录/授权配置</h4><p>我配置了匿名评论、GitHub、Twitter 与 Telegram 几种方式，可以根据自己的情况配置其他登录方式。</p><ul><li>匿名登录<ul><li><code>AUTH_ANON</code>：是否允许匿名评论，我选择了允许，即用户可以不登录评论</li></ul></li><li>GitHub 登录<ul><li><code>AUTH_GITHUB_CID</code> 与 <code>AUTH_GITHUB_CSEC</code>：GitHub OAuth App 的 Client ID 与 Client Secret</li></ul></li><li>Twitter 登录<ul><li><code>AUTH_TWITTER_CID</code> 与 <code>AUTH_TWITTER_CSEC</code>：Twitter OAuth App 的 Client ID 与 Client Secret</li></ul></li><li>Telegram 登录<ul><li><code>AUTH_TELEGRAM</code>：是否允许 Telegram 登录</li><li><code>TELEGRAM_TOKEN</code>：Telegram Bot Token，通过 <code>botfather</code> 创建</li></ul></li><li>邮箱登录<ul><li><code>AUTH_EMAIL_ENABLE</code>：是否允许邮箱登录</li><li><code>AUTH_EMAIL_FROM</code>：邮箱登录的发送邮箱</li></ul></li></ul><h4 id=通知配置>通知配置</h4><ul><li>Telegram 通知管理员，参看<a href=https://remark42.com/docs/configuration/telegram/>文档这部分</a>进行 Telegram Bot 的创建和配置<ul><li><code>NOTIFY_ADMINS</code>：通知管理员的方式，选择 telegram</li><li><code>NOTIFY_TELEGRAM_CHAN</code>：如启用 telegram 通知管理员，需要配置对应 Channel id，只需要填写 <code>t.me/xxx</code> 后面的 id 部分即可，如 <code>pseudoyuchat</code></li></ul></li><li>Email 通知用户，参看<a href=https://remark42.com/docs/configuration/email/>文档这部分</a>进行邮箱 SMTP 等配置<ul><li><code>NOTIFY_USERS</code>：通知用户的方式，我选择了了 email, 即邮件通知，则需要配置下文的 SMTP</li><li><code>NOTIFY_EMAIL_FROM</code>：邮箱通知的发送地址</li></ul></li></ul><h4 id=邮件-smtp-配置>邮件 SMTP 配置</h4><p>上文的邮箱登录与邮箱通知都需要配置 SMTP 服务器，这部分也可以根据自己的邮箱服务商<a href=https://remark42.com/docs/configuration/email/>参照文档</a>进行配置。</p><ul><li><code>SMTP_HOST</code>：SMTP 服务器地址</li><li><code>SMTP_PORT</code>：SMTP 服务器端口</li><li><code>SMTP_TLS</code>：是否启用 TLS</li><li><code>SMTP_USERNAME</code>：SMTP 用户名</li><li><code>SMTP_PASSWORD</code>：SMTP 密码</li></ul><h3 id=导入环境变量到服务>导入环境变量到服务</h3><p>根据以上说明完成环境变量配置后，在配置文件和环境变量文件所在目录运行以下命令导入环境变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fly secrets import &lt; prod.env
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/fly_secret_import.png alt=fly_secret_import></p><p><img src=https://image.pseudoyu.com/images/deploy_status_remark42.png alt=deploy_status_remark42></p><p>执行完成后到 fly.io 控制台查看服务状态即可，如为 <code>Deployed</code> 状态即表示部署成功。</p><h3 id=配置自定义域名可选>配置自定义域名（可选）</h3><p>如果你不想使用 fly.io 提供的默认域名，可以配置自定义域名。</p><p><img src=https://image.pseudoyu.com/images/custom_domain_flyio.png alt=custom_domain_flyio></p><p>进入 fly.io 控制台，选择刚部署的 <code>yu-remark42-01</code> 服务，点击左侧的 <code>Certificates</code> 选项，然后点击右上角 <code>Add a Certificate</code>，按照提示添加自定义域名即可。</p><p><img src=https://image.pseudoyu.com/images/custom_domain_dns_in_fly.png alt=custom_domain_dns_in_fly></p><p>点击 <code>Create Certificate</code> 后，会有一个页面显示你所需要添加的 DNS 记录，按照提示添加即可。</p><p><img src=https://image.pseudoyu.com/images/cloudflare_dns_remark42.png alt=cloudflare_dns_remark42></p><p><img src=https://image.pseudoyu.com/images/flyio_certificate_success.png alt=flyio_certificate_success></p><p>例如我的域名托管在 Cloudflare，我按照提示添加了两条 DNS 记录，返回页面后点击 <code>Check again</code> 或等待一段时间后刷新查看，都显示绿色即为配置成功。</p><p><img src=https://image.pseudoyu.com/images/change_remark_url.png alt=change_remark_url></p><p>此时，我们可以在 <code>fly.toml</code> 中修改 <code>REMARK_URL</code> 为自定义域名，然后执行以下命令重新部署服务即可，之后对配置文件进行任何改动都可以使用该命令进行更新：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fly deploy
</span></span></code></pre></div><h2 id=博客配置-remark42>博客配置 Remark42</h2><p>上文我们完成的 Remark42 服务的部署，现在则需要在我们的博文中加入 Remark42 评论组件，以我使用的 Hugo 博客为例。</p><h3 id=定义-hugo-主题-comments-组件>定义 Hugo 主题 Comments 组件</h3><p>我在 Hugo 博客的 <code>layouts/partials</code> 目录下新建了一个 <code>comments.html</code> 文件，用于定义 Remark42 评论组件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;comments&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;title&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>span</span><span class=p>&gt;</span>Comments<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;counter&#34;</span><span class=p>&gt;&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;remark42__counter&#34;</span> <span class=na>data-url</span><span class=o>=</span><span class=s>&#34;{{ .Permalink }}&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;remark42&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>remark_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;https://comments.pseudoyu.com&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>site_id</span><span class=o>:</span> <span class=s1>&#39;pseudoyu.com&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>components</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;embed&#39;</span><span class=p>,</span> <span class=s1>&#39;counter&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>max_shown_comments</span><span class=o>:</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>simple_view</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>theme</span><span class=o>:</span> <span class=s1>&#39;light&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// init or reset remark42
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>remark42</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>REMARK42</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>remark42</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>remark42</span><span class=p>.</span><span class=nx>destroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>remark42</span><span class=p>.</span><span class=nx>createInstance</span><span class=p>(</span><span class=nx>remark_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>component</span> <span class=k>of</span> <span class=nx>remark_config</span><span class=p>.</span><span class=nx>components</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kd>var</span> <span class=nx>d</span> <span class=o>=</span> <span class=nb>document</span><span class=p>,</span> <span class=nx>s</span> <span class=o>=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;script&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>s</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>remark_config</span><span class=p>.</span><span class=nx>host</span><span class=si>}</span><span class=sb>/web/</span><span class=si>${</span><span class=nx>component</span><span class=si>}</span><span class=sb>.mjs`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>s</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=s1>&#39;module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>s</span><span class=p>.</span><span class=nx>defer</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// prevent the &lt;script&gt; from loading mutiple times by InstantClick
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>s</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;data-no-instant&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nx>d</span><span class=p>.</span><span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})();</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><code>remark_config</code> 中的 <code>host</code> 与 <code>site_id</code> 需要根据自己的实际配置进行修改，其他部分配置可以保持不变，或根据文档进行调整。</p><p>配置好 <code>commnets</code> 组件后，在 <code>layouts/posts/single.html</code> 中文章底部引入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>{{ partial &#34;comments.html&#34; . }}
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/add_comments_code_in_hugo.png alt=add_comments_code_in_hugo></p><p>大体位置如图所示，如使用的是其他主题或博客系统，则需要找到自己文章对应的模板文件进行修改。</p><h3 id=本地预览部署网站>本地预览/部署网站</h3><p><img src=https://image.pseudoyu.com/images/test_remark42_embedded.png alt=test_remark42_embedded></p><p>此时可以在本地预览或部署网站以查看评论系统是否正常显示，至此我们的服务部署完成。</p><h3 id=获取-user-id-并配置-admin>获取 User ID 并配置 Admin</h3><p><img src=https://image.pseudoyu.com/images/get_user_id_remark42.png alt=get_user_id_remark42></p><p>登录授权完成后并测试评论后，可在 Remark42 中点击头像打开管理页面，双击后 <code>CMD/Ctrl+C</code> 可以获取以 <code>github_</code> 或其他平台开头的 User ID，可以将其配置到 <code>ADMIN_SHARED_ID</code> 中（更改 <code>fly.toml</code> 配置文件并运行 <code>fly deploy</code> 重新部署，即可成为管理员，管理员有权限对其他用户的评论进行删除等管理操作。</p><h2 id=其他>其他</h2><p>我把之前 Cusdis 中的评论数据按照一定条件导出 json 格式的数据，并通过 go 程序进行格式转换与迁移，因此保留了之前所有的评论。</p><p>因为 Cusdis 本身不提供导出功能且迁移的需求太过小众，我并没有直接向上游贡献代码，也没有写成完善的脚本，有类似需求的朋友可以参考这个 PR 进行处理 —— 「<a href=https://github.com/pseudoyu/remark42/pull/1/>feat: add cusdis to remark42 migrator support by pseudoyu · Pull Request #1 · pseudoyu/remark42</a>」。</p><h2 id=总结>总结</h2><p>以上就是我的博客评论系统的搭建过程，评论系统的搭建与配置相对繁复，且本文的配置方式或许会随时时间而过时，遇到问题可多参照<a href=https://remark42.com/docs/getting-started/installation/>官方文档</a>。</p><p>这是我的博客搭建部署系列教程之一，如对数据统计系统、博客内搜索等搭建感兴趣，请持续关注，希望能对大家有所参考。</p></articl><h2>相关文章</h2><dl class=row></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2024-07-02</dt><dd class=col-md-9><a href=/zh/2024/07/02/protect_your_image_using_webp_and_cloudflare_waf/>使用 WebP Cloud 与 Cloudflare WAF 为你的图床添加隐私和版权保护</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2024-06-30</dt><dd class=col-md-9><a href=/zh/2024/06/30/free_image_hosting_system_using_r2_webp_cloud_and_picgo/>从零开始搭建你的免费图床系统（Cloudflare R2 + WebP Cloud + PicGo）</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-05-29</dt><dd class=col-md-9><a href=/zh/2022/05/29/deploy_your_blog_using_hugo_and_github_action/>Hugo + GitHub Action，搭建你的博客自动发布系统</a></dd></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-05-24</dt><dd class=col-md-9><a href=/zh/2022/05/24/free_and_lightweight_blog_comment_system_using_cusdis_and_railway/>轻量级开源免费博客评论系统解决方案 （Cusdis + Railway）</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-05-21</dt><dd class=col-md-9><a href=/zh/2022/05/21/free_blog_analysis_using_umami_vercel_and_heroku/>从零开始搭建一个免费的个人博客数据统计系统（umami + Vercel + Heroku）</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://www.pseudoyu.com><img src=/images/author.webp alt=pseudoyu></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>pseudoyu</p><p class=author-desc>后端 & 智能合约研发工程师，HKU ECICer。喜欢探索新技术，空闲时也折腾博客搭建、效率工具等。 在 <a href=https://github.com/pseudoyu>GitHub</a> 关注我。在我的 <a href=https://t.me/pseudoyulife>Telegram 频道</a>了解更多。</p></div></div></div><div align=center><div class=comment-underline></div></div><br><div class=comments><div class=title><span>Comments</span>
<span class=counter><span class=remark42__counter data-url=https://www.pseudoyu.com/zh/2024/07/22/free_commenting_system_using_remark42_and_flyio/></span></span></div><div id=remark42></div></div><script>var remark_config={host:"https://comments.pseudoyu.com",site_id:"pseudoyu.com",components:["embed","counter"],max_shown_comments:20,simple_view:!0,theme:"light"}</script><script>(function(){const t=window.REMARK42;if(t)t.destroy(),t.createInstance(remark_config);else for(const t of remark_config.components){var n=document,e=n.createElement("script");e.src=`${remark_config.host}/web/${t}.mjs`,e.type="module",e.defer=!0,e.setAttribute("data-no-instant",""),n.head.appendChild(e)}})()</script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://www.pseudoyu.com/zh/tags/>标签</a></li><li><a href=https://www.pseudoyu.com/zh/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://www.pseudoyu.com/zh/index.xml><i class="fas fa-rss-square"></i> RSS</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社交</div><ul class=list-unstyled><li><a href=https://t.me/pseudoyulife rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/pseudo_yu rel=noopener target=_blank>Twitter</a></li><li><a href=https://www.instagram.com/pseudo.yu/ rel=noopener target=_blank>Instagram</a></li><li><a href=https://space.bilibili.com/5374948/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>关于</div><ul class=list-unstyled><li><a href=https://github.com/pseudoyu rel=noopener target=_blank>Yu's GitHub</a></li><li><a href=https://uptime.pseudoyu.com/status/services rel=noopener target=_blank>Yu's Services</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em><a href="https://stats.pseudoyu.com?access-token=2m1u5i2k413q0733h2a3332w3m1t6r634g1m6n" rel=noopener target=_blank>Yu's blog analytics</a></em></small><br><small><em>Powered by <a href=https://gohugo.io rel=noopener target=_blank>Hugo</a> - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>den</a></em></small><br><small><em><a href=https://www.hku.hk rel=noopener target=_blank>The University of Hong Kong</a> - <a href=https://www.cs.hku.hk rel=noopener target=_blank>CS</a></em></small><br><small>&copy;
Yu Zhang
2020 -
2024</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>