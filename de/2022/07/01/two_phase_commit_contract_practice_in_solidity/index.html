<!doctype html><html lang=de itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.105.0"><meta charset=utf-8><title>Implementierung von Two-Phase Commit in Solidity Smart Contracts unter Verwendung von State Locks · Pseudoyu</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script data-goatcounter=https://stats.pseudoyu.com/count async src=//stats.pseudoyu.com/count.js></script><meta name=description content="《后来的我们 - 五月天》 Vorwort In Smart-Contract-Anwendungen, die Interaktionen zwischen mehreren Systemen oder Verträgen beinhalten, insbesondere in Geschäftsbereichen, in denen die Genauigkeit von Vermögenswerte"><meta name=keywords content="hugo,blockchain,programming"><link rel=canonical href=https://www.pseudoyu.com/de/2022/07/01/two_phase_commit_contract_practice_in_solidity/><link rel=alternate href=https://www.pseudoyu.com/zh/2022/07/01/two_phase_commit_contract_practice_in_solidity/ hreflang=zh><link rel=alternate href=https://www.pseudoyu.com/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/ hreflang=en><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://www.pseudoyu.com/css/den.css><link rel=stylesheet href=https://www.pseudoyu.com/css/custom.css><meta property="og:title" content="Implementierung von Two-Phase Commit in Solidity Smart Contracts unter Verwendung von State Locks"><meta property="og:description" content="《后来的我们 - 五月天》 Vorwort In Smart-Contract-Anwendungen, die Interaktionen zwischen mehreren Systemen oder Verträgen beinhalten, insbesondere in Geschäftsbereichen, in denen die Genauigkeit von Vermögenswerte"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/de/2022/07/01/two_phase_commit_contract_practice_in_solidity/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-01T10:54:57+08:00"><meta property="article:modified_time" content="2022-07-01T10:54:57+08:00"><meta itemprop=name content="Implementierung von Two-Phase Commit in Solidity Smart Contracts unter Verwendung von State Locks"><meta itemprop=description content="《后来的我们 - 五月天》 Vorwort In Smart-Contract-Anwendungen, die Interaktionen zwischen mehreren Systemen oder Verträgen beinhalten, insbesondere in Geschäftsbereichen, in denen die Genauigkeit von Vermögenswerte"><meta itemprop=datePublished content="2022-07-01T10:54:57+08:00"><meta itemprop=dateModified content="2022-07-01T10:54:57+08:00"><meta itemprop=wordCount content="1852"><meta itemprop=keywords content="blockchain,ethereum,solidity,smart contract,web3,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementierung von Two-Phase Commit in Solidity Smart Contracts unter Verwendung von State Locks"><meta name=twitter:description content="《后来的我们 - 五月天》 Vorwort In Smart-Contract-Anwendungen, die Interaktionen zwischen mehreren Systemen oder Verträgen beinhalten, insbesondere in Geschäftsbereichen, in denen die Genauigkeit von Vermögenswerte"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.pseudoyu.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.pseudoyu.com/de/><img class="mr20 header-logo-image" src=https://www.pseudoyu.com/images/icon.png alt=logo>
Pseudoyu</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/category/ideas/>Ideen</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/category/tools/>Tools</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/category/develop/>Code</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/links/>Links</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/search/>Suche</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/about/>Über</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/><i class="fas fa-globe"></i> 简</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/><i class="fas fa-globe"></i> EN</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>Implementierung von Two-Phase Commit in Solidity Smart Contracts unter Verwendung von State Locks</h1><p class=header-date>Autor:
pseudoyu
| <span>1852 Wörter, 4 Minuten</span>
| <span class=remark42__counter data-url=https://www.pseudoyu.com/de/2022/07/01/two_phase_commit_contract_practice_in_solidity/></span> Kommentare
| 2022-07-01
| Kategorie:
<a href=https://www.pseudoyu.com/de/category/develop/>Develop</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.pseudoyu.com/de/tag/blockchain/>blockchain</a>,
<a href=https://www.pseudoyu.com/de/tag/ethereum/>ethereum</a>,
<a href=https://www.pseudoyu.com/de/tag/smart-contract/>smart contract</a>,
<a href=https://www.pseudoyu.com/de/tag/solidity/>solidity</a>,
<a href=https://www.pseudoyu.com/de/tag/web3/>web3</a></p><div class=clearfix></div><p class="float-right translations"><i class="fas fa-language" aria-hidden=true></i>
Übersetzungen:
<a href=https://www.pseudoyu.com/zh/2022/07/01/two_phase_commit_contract_practice_in_solidity/>ZH</a>, <a href=https://www.pseudoyu.com/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/>EN</a></p></div></div></div></div></div><main><div class="container content"><articl data-pagefind-body><figure><audio controls preload=metadata><source src=/audios/here_after_us.mp3 type=audio/mpeg></audio><i><figcaption>《后来的我们 - 五月天》</figcaption></i></figure><h2 id=vorwort>Vorwort</h2><p>In Smart-Contract-Anwendungen, die Interaktionen zwischen mehreren Systemen oder Verträgen beinhalten, insbesondere in Geschäftsbereichen, in denen die Genauigkeit von Vermögenswerten oder Daten sensibel ist, müssen wir die Datenatomizität während des gesamten Geschäftsprozesses sicherstellen. Daher müssen wir auf Vertragsebene einen Mechanismus implementieren, der dem mehrstufigen Commit ähnelt und den Zustandsänderungsprozess im Vertrag in zwei Phasen zerlegt: Vor-Commit und formaler Commit.</p><p>Dieser Artikel implementiert ein minimalistisches Zwei-Phasen-Commit-Modell unter Verwendung eines Zustandssperrmechanismus. Der vollständige Vertragscode ist unter <a href=https://github.com/pseudoyu/learn-solidity/blob/master/practice/two_phase_commit/TwoPhaseCommit.sol>TwoPhaseCommit.sol</a> zu finden. Im Folgenden wird die Kernlogik dieses Vertrags erläutert und es wird angestrebt, Stilrichtlinien und Best Practices zu befolgen.</p><blockquote><p>Hinweis: Dieser Vertrag wurde hauptsächlich für den geschäftlichen Einsatz in Konsortialketten konzipiert und wurde nicht speziell für Gasgebühren optimiert. Er dient nur zu Lernzwecken.</p></blockquote><h2 id=vertragslogik>Vertragslogik</h2><h3 id=vertragsstruktur>Vertragsstruktur</h3><p>Das Zwei-Phasen-Commit-Szenario umfasst die folgenden Methoden:</p><ol><li>set: Zwei-Phasen - Vor-Commit</li><li>commit: Zwei-Phasen - Formaler Commit</li><li>rollback: Zwei-Phasen - Rollback</li></ol><p>Aufgrund der Einschränkungen der Solidity-Sprache bei der Beurteilung und dem Vergleich von Zeichenkettenlängen bietet dieser Vertrag zur Verbesserung der Lesbarkeit des Vertragscodes einige Hilfsmethoden, hauptsächlich einschließlich:</p><ol><li>isValidKey: Überprüft, ob der Schlüssel gültig ist</li><li>isValidValue: Überprüft, ob der Wert gültig ist</li><li>isEqualString: Vergleicht, ob zwei Zeichenketten gleich sind</li></ol><h3 id=zwei-phasen-commit-kernlogik>Zwei-Phasen-Commit Kernlogik</h3><p>Im Zwei-Phasen-Commit-Szenario bietet dieser Vertrag einen einfachen Satz von <code>set</code>, <code>commit</code> und <code>rollback</code> Methoden, um Schlüssel-Wert-Paare, die in Vertragsaufrufen übergeben werden, in der Kette zu speichern. Wir verwenden einen Zustandssperrmechanismus, um die Atomizität von kettenübergreifenden Transaktionen zu erreichen. Wir definieren die folgenden Datenstrukturen:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>enum</span> <span class=nc>State</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>UNLOCKED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LOCKED</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>struct</span> <span class=nc>Payload</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>State</span> <span class=n>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>lockValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Hier ist <code>State</code> ein Aufzählungstyp, der den Sperrstatus des Schlüssels in der Kette aufzeichnet, während die <code>Payload</code>-Struktur den Sperrstatus, den aktuellen Wert und den gesperrten Wert speichert. Sie ist durch die folgende <code>mapping</code>-Struktur an den Schlüssel gebunden:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>mapping</span> <span class=p>(</span><span class=kt>string</span> <span class=o>=&gt;</span> <span class=n>Payload</span><span class=p>)</span> <span class=n>keyToPayload</span><span class=p>;</span>
</span></span></code></pre></div><p>So können wir den Zustand jedes Schlüssels im Vertragsaufruf basierend auf <code>keyToPayload</code> verfolgen und den Zustand des Schlüssels in den folgenden <code>set</code>, <code>commit</code> und <code>rollback</code> Methoden zur Ausnahmebehandlung überprüfen.</p><h4 id=set>set()</h4><p>In der <code>set()</code>-Methode überprüfen wir den Zustand des Schlüssels. Wenn er <code>State.LOCKED</code> ist, wird keine Speicherung durchgeführt und eine Ausnahme wird ausgelöst:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>LOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Wenn er <code>State.UNLOCKED</code> ist, wird der im Vertragsaufruf übergebene Wert in lockValue gespeichert und sein Zustand wird auf <code>LOCKED</code> gesetzt, um auf anschließendes <code>commit</code> oder <code>rollback</code> zur Entsperrung zu warten.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>State</span><span class=p>.</span><span class=n>LOCKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span></code></pre></div><h4 id=commit>commit()</h4><p>In der <code>commit()</code>-Methode überprüfen wir den Zustand des Schlüssels. Wenn er <code>State.UNLOCKED</code> ist, wird für diesen Schlüssel keine Operation durchgeführt und eine Ausnahme wird ausgelöst:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Wenn er <code>State.LOCKED</code> ist, überprüfen wir, ob der im Vertragsaufruf übergebene Wert gleich lockValue ist. Wenn nicht gleich, wird eine Ausnahme ausgelöst:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isEqualString</span><span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span><span class=p>,</span> <span class=n>_value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Wenn die Werte gleich sind, wird der diesem Schlüssel entsprechende Wert in der Kette gespeichert, der Zustand des Schlüssels wird auf <code>UNLOCKED</code> gesetzt, der aktuelle Wert <code>value</code> wird aktualisiert und <code>lockValue</code> wird geleert:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>store</span><span class=p>[</span><span class=n>_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=nb>value</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span></code></pre></div><h4 id=rollback>rollback()</h4><p>In der <code>rollback()</code>-Methode überprüfen wir den Zustand des Schlüssels. Wenn er <code>State.UNLOCKED</code> ist, wird für diesen Schlüssel keine Operation durchgeführt und eine Ausnahme wird ausgelöst:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Wenn er <code>State.LOCKED</code> ist, überprüfen wir, ob der im Vertragsaufruf übergebene Wert gleich lockValue ist. Wenn nicht gleich, wird eine Ausnahme ausgelöst:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isEqualString</span><span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span><span class=p>,</span> <span class=n>_value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Wenn die Werte gleich sind, wird der Zustand des Schlüssels auf <code>UNLOCKED</code> gesetzt und <code>lockValue</code> wird geleert:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=fehlerbehandlungslogik>Fehlerbehandlungslogik</h3><p>In Ausnahmeszenarien der Vertragsausführung werfen wir Fehler und führen Rollbacks durch. Um die Lesbarkeit der Fehlermeldungen zu verbessern und die Fehlererfassung und -behandlung durch Anwendungspersonal der oberen Ebene zu erleichtern, haben wir den Ansatz der Fehlertypdefinition gewählt und verschiedene Ausnahmeszenarien definiert. Da ich bereits die meisten Informationen in der Fehlerbenennung einbezogen habe, wurden keine zusätzlichen Parameterwerte für Fehlertypen definiert, die nach Bedarf angepasst werden können.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataKeyIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataValueIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsNotExist</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span></code></pre></div><p>In der spezifischen Vertragslogik werfen wir Ausnahmen mit der <code>revert</code>-Methode, wie zum Beispiel:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidKey</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_key</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataKeyIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidValue</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_value</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataValueIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isEqualString</span><span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span><span class=p>,</span> <span class=n>_value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=generische-parametervalidierung>Generische Parametervalidierung</h3><p>Wir führen einige Gültigkeitsprüfungen für Eingabeparameter durch. Um Erweiterbarkeit zu bieten, verwenden wir die Methoden <code>isValidKey()</code> und <code>isValidValue()</code>, um Schlüssel und Werte unabhängig zu validieren:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @notice Daten-Schlüssel-Format-Validierung
</span></span></span><span class=line><span class=cl><span class=cm> * @param _key Daten - Schlüssel
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nf>isValidKey</span><span class=p>(</span><span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_key</span><span class=p>)</span> <span class=k>private</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>key</span> <span class=o>=</span> <span class=n>_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=n>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @notice Daten-Wert-Format-Validierung
</span></span></span><span class=line><span class=cl><span class=cm> * @param _value Daten - Wert
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nf>isValidValue</span><span class=p>(</span><span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_value</span><span class=p>)</span> <span class=k>private</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=nb>value</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>value</span><span class=p>.</span><span class=n>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Dieser Vertrag führt nur Nicht-Null-Überprüfungen durch. Sie können die Geschäftslogik nach Geschäftsanforderungen anpassen und sie dort aufrufen, wo eine Validierung erforderlich ist, wie zum Beispiel:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidKey</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_key</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataKeyIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidValue</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_value</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataValueIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidValue</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>store</span><span class=p>[</span><span class=n>_key</span><span class=p>])))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotExist</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ereignismechanismus>Ereignismechanismus</h3><p>Zusätzlich haben wir Ereignisse definiert, die den Kernmethoden entsprechen, und für Ereignisse indiziert sind, um die Überwachung und Verarbeitung durch Anwendungen der oberen Ebene zu erleichtern.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>event</span> <span class=nc>setEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>event</span> <span class=nc>getEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>event</span> <span class=nc>commitEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>event</span> <span class=nc>rollbackEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span></code></pre></div><p>Ereignisse werden in Vertragsmethoden mit der <code>emit()</code>-Methode ausgelöst, wie zum Beispiel:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>emit</span> <span class=n>setEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>emit</span> <span class=n>getEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>emit</span> <span class=n>commitEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>emit</span> <span class=n>rollbackEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=fazit>Fazit</h2><p>Das oben Genannte ist eine Best Practice für meinen Zwei-Phasen-Commit-Vertrag. Für grundlegende Solidity-Syntax verweise ich auf &ldquo;<a href=https://www.pseudoyu.com/de/2022/05/25/learn_solidity_from_scratch_basic/>Solidity Smart Contract Entwicklung - Grundlagen</a>&rdquo;. Ich werde in Zukunft weiterhin üben und mehr Vertragsszenarien erklären, also bleiben Sie dran.</p><h2 id=referenzen>Referenzen</h2><blockquote><ol><li><a href=https://github.com/pseudoyu/learn-solidity/blob/master/practice/two_phase_commit/TwoPhaseCommit.sol>TwoPhaseCommit.sol Vertragsquellcode</a></li><li><a href=https://www.pseudoyu.com/de/2022/05/25/learn_solidity_from_scratch_basic/>Solidity Smart Contract Entwicklung - Grundlagen</a></li><li><a href=https://docs.soliditylang.org/en/v0.8.15/>Solidity Offizielle Dokumentation</a></li></ol></blockquote></articl><h2>Verwandte Beiträge</h2><dl class=row></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-09-13</dt><dd class=col-md-9><a href=/de/2023/09/13/weekly_review_20230913/>Wochenrückblick #46 - Abschied von langen Haaren, ursprüngliche Intention des Wochenrückblicks und Vertragsentwicklung</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-04-30</dt><dd class=col-md-9><a href=/de/2023/04/30/weekly_review_20230430/>Wochenrückblick #38 - Foundry Contract-Tests, Logseq Aufgabenverwaltung und Surge Ponte Remote-Entwicklung</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-06-09</dt><dd class=col-md-9><a href=/de/2022/06/09/learn_solidity_from_scratch_hardhat/>Solidity Smart Contract Entwicklung - Verwendung des Hardhat Frameworks</a></dd></dl></dl><dt class=col-md-3>2022-06-08</dt><dd class=col-md-9><a href=/de/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity Smart Contract Entwicklung - Beherrschung von ethers.js</a></dd></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-05-30</dt><dd class=col-md-9><a href=/de/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity Smart Contract Entwicklung - Meistern von Web3.py</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://www.pseudoyu.com><img src=/images/author.webp alt=pseudoyu></a></div><div class=author-content><p class=author-title>Autor</p><p class=author-name>pseudoyu</p><p class=author-desc>Backend- & Smart-Contract-Entwickler, MSc-Absolvent in ECIC (Electronic Commerce and Internet Computing) an der Universität Hongkong (HKU). Lerne und entwickle gerne Neues. <a href=https://github.com/pseudoyu>Folge mir auf GitHub</a></p></div></div></div><div align=center><div class=comment-underline></div></div><br><div class=comments><div class=title><span>Comments</span>
<span class=counter><span class=remark42__counter data-url=https://www.pseudoyu.com/de/2022/07/01/two_phase_commit_contract_practice_in_solidity/></span></span></div><div id=remark42></div></div><script>var remark_config={host:"https://comments.pseudoyu.com",site_id:"pseudoyu.com",components:["embed","counter"],max_shown_comments:20,simple_view:!0,theme:"light"}</script><script>(function(){const t=window.REMARK42;if(t)t.destroy(),t.createInstance(remark_config);else for(const t of remark_config.components){var n=document,e=n.createElement("script");e.src=`${remark_config.host}/web/${t}.mjs`,e.type="module",e.defer=!0,e.setAttribute("data-no-instant",""),n.head.appendChild(e)}})()</script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Sitemap</div><ul class=list-unstyled><li><a href=https://www.pseudoyu.com/de/tags/>Schlagworte</a></li><li><a href=https://www.pseudoyu.com/de/categories/>Kategorien</a></li><li><a rel=alternate type=application/rss+xml href=https://www.pseudoyu.com/de/index.xml><i class="fas fa-rss-square"></i> RSS-Feed</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Social</div><ul class=list-unstyled><li><a href=https://t.me/pseudoyulife rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/pseudo_yu rel=noopener target=_blank>Twitter</a></li><li><a href=https://www.instagram.com/pseudo.yu/ rel=noopener target=_blank>Instagram</a></li><li><a href=https://space.bilibili.com/5374948/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Links</div><ul class=list-unstyled><li><a href=https://github.com/pseudoyu rel=noopener target=_blank>Yu's GitHub</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em><a href="https://stats.pseudoyu.com?access-token=2m1u5i2k413q0733h2a3332w3m1t6r634g1m6n" rel=noopener target=_blank>Yu's blog analytics</a></em></small><br><small><em>Powered by <a href=https://gohugo.io rel=noopener target=_blank>Hugo</a> - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>den</a></em></small><br><small><em><a href=https://www.hku.hk rel=noopener target=_blank>The University of Hong Kong</a> - <a href=https://www.cs.hku.hk rel=noopener target=_blank>CS</a></em></small><br><small>&copy;
Yu Zhang
2020 -
2024</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>