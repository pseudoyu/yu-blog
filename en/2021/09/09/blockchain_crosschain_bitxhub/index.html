<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.105.0"><meta charset=utf-8><title>BitXHub Cross-chain Plugin (Fabric) Source Code Analysis · Pseudoyu</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script data-goatcounter=https://stats.pseudoyu.com/count async src=//stats.pseudoyu.com/count.js></script><meta name=description content="Preface I previously mentioned that BitXHub cross-chain platform by QulianTech is a relatively comprehensive open-source cross-chain solution in the industry. It mainly optimizes the functionality, security, and flexibility of the cross-chain process through relay chain, gateway, and plugin mechanisms. Currently, our company&amp;rsquo;s team is working on a cross-chain module for a BaaS platform. I am responsible for the cross-chain adapter part, which corresponds to the listening module and application chain"><meta name=keywords content="hugo,blockchain,programming"><link rel=canonical href=https://www.pseudoyu.com/en/2021/09/09/blockchain_crosschain_bitxhub/><link rel=alternate href=https://www.pseudoyu.com/zh/2021/09/09/blockchain_crosschain_bitxhub/ hreflang=zh><link rel=alternate href=https://www.pseudoyu.com/de/2021/09/09/blockchain_crosschain_bitxhub/ hreflang=de><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://www.pseudoyu.com/css/den.css><link rel=stylesheet href=https://www.pseudoyu.com/css/custom.css><meta property="og:title" content="BitXHub Cross-chain Plugin (Fabric) Source Code Analysis"><meta property="og:description" content="Preface I previously mentioned that BitXHub cross-chain platform by QulianTech is a relatively comprehensive open-source cross-chain solution in the industry. It mainly optimizes the functionality, security, and flexibility of the cross-chain process through relay chain, gateway, and plugin mechanisms. Currently, our company&rsquo;s team is working on a cross-chain module for a BaaS platform. I am responsible for the cross-chain adapter part, which corresponds to the listening module and application chain"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/en/2021/09/09/blockchain_crosschain_bitxhub/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-09T15:14:26+08:00"><meta property="article:modified_time" content="2021-09-09T15:14:26+08:00"><meta itemprop=name content="BitXHub Cross-chain Plugin (Fabric) Source Code Analysis"><meta itemprop=description content="Preface I previously mentioned that BitXHub cross-chain platform by QulianTech is a relatively comprehensive open-source cross-chain solution in the industry. It mainly optimizes the functionality, security, and flexibility of the cross-chain process through relay chain, gateway, and plugin mechanisms. Currently, our company&rsquo;s team is working on a cross-chain module for a BaaS platform. I am responsible for the cross-chain adapter part, which corresponds to the listening module and application chain"><meta itemprop=datePublished content="2021-09-09T15:14:26+08:00"><meta itemprop=dateModified content="2021-09-09T15:14:26+08:00"><meta itemprop=wordCount content="2106"><meta itemprop=keywords content="blockchain,crosschain,bitxhub,hyperledger fabric,go,"><meta name=twitter:card content="summary"><meta name=twitter:title content="BitXHub Cross-chain Plugin (Fabric) Source Code Analysis"><meta name=twitter:description content="Preface I previously mentioned that BitXHub cross-chain platform by QulianTech is a relatively comprehensive open-source cross-chain solution in the industry. It mainly optimizes the functionality, security, and flexibility of the cross-chain process through relay chain, gateway, and plugin mechanisms. Currently, our company&rsquo;s team is working on a cross-chain module for a BaaS platform. I am responsible for the cross-chain adapter part, which corresponds to the listening module and application chain"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.pseudoyu.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.pseudoyu.com/en/><img class="mr20 header-logo-image" src=https://www.pseudoyu.com/images/icon.png alt=logo>
Pseudoyu</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/ideas/>Idea</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/tools/>Tool</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/develop/>Develop</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/links/>Links</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/about/>About</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/search/>Search</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/><i class="fas fa-globe"></i> 简</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/><i class="fas fa-globe"></i> DE</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>BitXHub Cross-chain Plugin (Fabric) Source Code Analysis</h1><p class=header-date>Author:
pseudoyu
| <span>2106 words, 5 minutes</span>
| <span class=remark42__counter data-url=https://www.pseudoyu.com/en/2021/09/09/blockchain_crosschain_bitxhub/></span> comments
| 2021-09-09
| Category:
<a href=https://www.pseudoyu.com/en/category/develop/>Develop</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.pseudoyu.com/en/tag/bitxhub/>bitxhub</a>,
<a href=https://www.pseudoyu.com/en/tag/blockchain/>blockchain</a>,
<a href=https://www.pseudoyu.com/en/tag/crosschain/>crosschain</a>,
<a href=https://www.pseudoyu.com/en/tag/go/>go</a>,
<a href=https://www.pseudoyu.com/en/tag/hyperledger-fabric/>hyperledger fabric</a></p><div class=clearfix></div><p class="float-right translations"><i class="fas fa-language" aria-hidden=true></i>
Translations:
<a href=https://www.pseudoyu.com/zh/2021/09/09/blockchain_crosschain_bitxhub/>ZH</a>, <a href=https://www.pseudoyu.com/de/2021/09/09/blockchain_crosschain_bitxhub/>DE</a></p></div></div></div></div></div><main><div class="container content"><articl data-pagefind-body><h2 id=preface>Preface</h2><p>I previously mentioned that BitXHub cross-chain platform by QulianTech is a relatively comprehensive open-source cross-chain solution in the industry. It mainly optimizes the functionality, security, and flexibility of the cross-chain process through relay chain, gateway, and plugin mechanisms.</p><p>Currently, our company&rsquo;s team is working on a cross-chain module for a BaaS platform. I am responsible for the cross-chain adapter part, which corresponds to the listening module and application chain plugin module in the BitXHub platform. The adapter will listen to cross-chain events on the application chain and pass the corresponding parameters to the gateway for cross-chain related business logic requirements.</p><p>Therefore, I plan to conduct an in-depth analysis of the source code of BitXHub&rsquo;s <a href=https://github.com/meshplus/pier-client-fabric>meshplus/pier-client-fabric</a> plugin to learn its excellent code structure and functional modules, in order to better implement my own adapter functionality.</p><h2 id=cross-chain-transaction-process>Cross-chain Transaction Process</h2><p><img src=https://image.pseudoyu.com/images/cross_chain_plugin.png alt=cross_chain_plugin></p><p>According to cross-chain business requirements, a typical cross-chain invocation process is shown in the above diagram.</p><ol><li>The subchain that needs to perform cross-chain transactions must install the adapter and deploy the provided cross-chain contract and business contract</li><li>When a user invokes the business contract through the SDK, the contract will call the cross-chain contract and throw a cross-chain event</li><li>The corresponding adapter of the subchain will poll or subscribe to the cross-chain events thrown by the cross-chain contract and send them to the listening module of the cross-chain gateway</li><li>The cross-chain gateway will convert the response method and parameters extracted from the cross-chain event into a transaction recognizable by the target subchain</li><li>The cross-chain gateway will submit the converted transaction to the target subchain and execute it</li></ol><h2 id=adapter-mechanism>Adapter Mechanism</h2><h3 id=interface-design>Interface Design</h3><p>The adapter is mainly responsible for interaction between subchains and participates in cross-chain interactions through interface calls. It mainly provides the following interfaces.</p><h4 id=invoke-chaincode>Invoke Chaincode</h4><p>The adapter receives transaction parameters sent by the cross-chain gateway, encapsulates them into a data structure accepted by the adapted subchain, and invokes the chaincode.</p><h4 id=query-cross-chain-transaction>Query Cross-chain Transaction</h4><p>The subchain stores cross-chain related details in the payload field, such as contract, user, etc. The adapter parses and encapsulates this information and provides corresponding interfaces for the cross-chain gateway to query.</p><h4 id=query-historical-transaction-information>Query Historical Transaction Information</h4><p>The adapter needs to provide a historical transaction query interface to actively query when cross-chain events are not received due to network transmission or other reasons.</p><h4 id=query-application-chain-basic-information>Query Application Chain Basic Information</h4><p>The adapter needs to provide a query interface for information related to its adapted subchain for the cross-chain gateway to query, such as name, type, etc.</p><h2 id=source-code-analysis>Source Code Analysis</h2><p>Next, we will analyze the core functional module source code of the BitXHub cross-chain plugin (Fabric).</p><h3 id=design-pattern>Design Pattern</h3><p>The plugin project adopts a typical &ldquo;producer-consumer&rdquo; model, which is very suitable for concurrent scenarios that need to poll/subscribe to receive data. This model utilizes the characteristic that only one goroutine accesses a certain data in the channel at any moment.</p><h4 id=subscribepoll-cross-chain-events>Subscribe/Poll Cross-chain Events</h4><p>The plugin needs to construct a producer object to subscribe to cross-chain events of its corresponding subchain.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Construct producer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ec</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>event</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>channelProvider</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nf>WithBlockEvents</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to create fabcli, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=p>.</span><span class=nx>eventClient</span> <span class=p>=</span> <span class=nx>ec</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Subscribe to cross-chain events
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>registration</span><span class=p>,</span> <span class=nx>notifier</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ec</span><span class=p>.</span><span class=nf>RegisterChaincodeEvent</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>CCID</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>EventFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to register chaincode event, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=p>.</span><span class=nx>registration</span> <span class=p>=</span> <span class=nx>registration</span>
</span></span></code></pre></div><p>The method to subscribe to events is to call the <code>RegisterChaincodeEvent()</code> method of <code>fabric-sdk-go</code>. It&rsquo;s important to note that when you no longer need to listen to events, you should call the <code>Unregister()</code> method to cancel the subscription.</p><p>The <code>ccID</code> in the method is the chaincode ID to be monitored, <code>eventFilter</code> is the chaincode event to be monitored, and this method will return a channel to receive data (when the subscription is canceled, the channel will be closed).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>RegisterChaincodeEvent</span><span class=p>(</span><span class=nx>ccID</span><span class=p>,</span> <span class=nx>eventFilter</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>fab</span><span class=p>.</span><span class=nx>Registration</span><span class=p>,</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>fab</span><span class=p>.</span><span class=nx>CCEvent</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>eventService</span><span class=p>.</span><span class=nf>RegisterChaincodeEvent</span><span class=p>(</span><span class=nx>ccID</span><span class=p>,</span> <span class=nx>eventFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Place both the object that has subscribed to the cross-chain contract (i.e., the producer) and the consumer in an infinite loop. When a cross-chain event is thrown, the producer will continuously put data into the channel, and the consumer will continuously take data out of the channel.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Producer writes cross-chain events to the channel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=nx>ccEvent</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>notifier</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>ccEvent</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>c</span><span class=p>.</span><span class=nf>handle</span><span class=p>(</span><span class=nx>ccEvent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Consumer takes cross-chain event data from the channel
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>ctx</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span></code></pre></div><p>Because both the producer and consumer are in an infinite loop, the producer&rsquo;s goroutine will not exit, and the channel continues to write data. When there are no new events, the consumer will block, waiting for the producer to receive new data and write it to the channel.</p><h3 id=plugin-initialization-running-and-closure>Plugin Initialization, Running, and Closure</h3><p>After looking at the overall design pattern, let&rsquo;s look at the mechanism of how the entire plugin project runs from the main entry point of the program.</p><h4 id=initialization>Initialization</h4><p>In the initialization of the client program, a consumer object is first constructed according to a custom structure.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Construct consumer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>mgh</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newFabricHandler</span><span class=p>(</span><span class=nx>contractmeta</span><span class=p>.</span><span class=nx>EventFilter</span><span class=p>,</span> <span class=nx>eventC</span><span class=p>,</span> <span class=nx>appchainID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>done</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>csm</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>NewConsumer</span><span class=p>(</span><span class=nx>configPath</span><span class=p>,</span> <span class=nx>contractmeta</span><span class=p>,</span> <span class=nx>mgh</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=running>Running</h4><p>The entry point for program execution is simple, just polling the cross-chain contract and starting the consumer object.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>Start</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Fabric consumer started&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>c</span><span class=p>.</span><span class=nf>polling</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=closure>Closure</h4><p>Closing the plugin is also simple, just stop the program from running and unsubscribe from events.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Close plugin
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>Stop</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>ticker</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>done</span> <span class=o>&lt;-</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Unsubscribe from events in the consumer package.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span> <span class=nf>Shutdown</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>eventClient</span><span class=p>.</span><span class=nf>Unregister</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>registration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Looking deeper, unsubscribing from events calls the <code>Unregister()</code> method of <code>fabric-sdk-go</code>, which will cancel the subscription to that event and close the corresponding channel.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>Unregister</span><span class=p>(</span><span class=nx>reg</span> <span class=nx>fab</span><span class=p>.</span><span class=nx>Registration</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>eventService</span><span class=p>.</span><span class=nf>Unregister</span><span class=p>(</span><span class=nx>reg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=interface-implementation>Interface Implementation</h3><p>In addition to subscribing to and monitoring events, the plugin also provides a series of query interfaces for the gateway to call to complete corresponding cross-chain operations.</p><h4 id=getproof>getProof()</h4><p>Such as obtaining Proof information, etc.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>getProof</span><span class=p>(</span><span class=nx>response</span> <span class=nx>channel</span><span class=p>.</span><span class=nx>Response</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>proof</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>handle</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>response</span> <span class=nx>channel</span><span class=p>.</span><span class=nx>Response</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// query proof from fabric
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>l</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ledger</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nx>channelProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>QueryTransaction</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>TransactionID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>pd</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>common</span><span class=p>.</span><span class=nx>Payload</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>TransactionEnvelope</span><span class=p>.</span><span class=nx>Payload</span><span class=p>,</span> <span class=nx>pd</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>pt</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>peer</span><span class=p>.</span><span class=nx>Transaction</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proto</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>pd</span><span class=p>.</span><span class=nx>Data</span><span class=p>,</span> <span class=nx>pt</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>pt</span><span class=p>.</span><span class=nx>Actions</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Payload</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>retry</span><span class=p>.</span><span class=nf>Retry</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>attempt</span> <span class=kt>uint</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>		<span class=nx>proof</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Can&#39;t get proof&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=nx>strategy</span><span class=p>.</span><span class=nf>Wait</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>logger</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;Can&#39;t get proof&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>proof</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=getchainid>getChainID()</h4><p>This interface is used to get the chain ID</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>GetChainID</span><span class=p>()</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>request</span> <span class=o>:=</span> <span class=nx>channel</span><span class=p>.</span><span class=nx>Request</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ChaincodeID</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>CCID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Fcn</span><span class=p>:</span>         <span class=nx>GetChainId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumer</span><span class=p>.</span><span class=nx>ChannelClient</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Payload</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>chainIds</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>Payload</span><span class=p>),</span> <span class=s>&#34;-&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>chainIds</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>chainIds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>chainIds</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=other-interfaces>Other Interfaces</h4><p>For more interface implementation details, please refer to <a href=https://github.com/meshplus/pier-client-fabric/blob/master/client.go>meshplus/pier-client-fabric/client.go</a>.</p><h3 id=cross-chain-contract>Cross-chain Contract</h3><p>The cross-chain contract is an important part of implementing plugin monitoring. When business needs to cross chains, it will uniformly call the cross-chain contract and interact with the cross-chain gateway.</p><p>The cross-chain contract provides a series of interfaces for business contracts to implement. Therefore, writing business contracts according to certain specifications can simplify the development and maintenance of cross-chain business. For details on writing cross-chain contracts, please refer to &lt;<a href=https://github.com/meshplus/bitxhub/wiki/%E8%B7%A8%E9%93%BE%E5%90%88%E7%BA%A6%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3>Cross-chain Contract Writing Documentation</a>>.</p><h4 id=event-implementation>Event Implementation</h4><p>How does the cross-chain contract throw cross-chain events to the plugin?</p><p>In the <code>Invoke()</code> method of the cross-chain contract, the cross-chain contract first obtains the calling method and corresponding parameters of the contract caller (i.e., the business contract) through the <code>GetFunctionAndParameters()</code> method, and then calls different contracts by judging the method name.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>broker</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>Invoke</span><span class=p>(</span><span class=nx>stub</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>ChaincodeStubInterface</span><span class=p>)</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>function</span><span class=p>,</span> <span class=nx>args</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>GetFunctionAndParameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=k>switch</span> <span class=nx>function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>case</span> <span class=s>&#34;getChainId&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getChainId</span><span class=p>(</span><span class=nx>stub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s>&#34;getInMessage&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getInMessage</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s>&#34;getOutMessage&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getOutMessage</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>case</span> <span class=s>&#34;EmitInterchainEvent&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>EmitInterchainEvent</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;invalid function: &#34;</span> <span class=o>+</span> <span class=nx>function</span> <span class=o>+</span> <span class=s>&#34;, args: &#34;</span> <span class=o>+</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>args</span><span class=p>,</span> <span class=s>&#34;,&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Let&rsquo;s focus on analyzing what the cross-chain contract does when <code>EmitInterchainEvent()</code> is called. The corresponding explanations are in the comments.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>broker</span> <span class=o>*</span><span class=nx>Broker</span><span class=p>)</span> <span class=nf>EmitInterchainEvent</span><span class=p>(</span><span class=nx>stub</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>ChaincodeStubInterface</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Judge whether the number of input parameters is correct
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Cross-chain contracts need to pass in many parameters, as call failures can easily cause security issues on the chain
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>5</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;incorrect number of arguments, expecting 7&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Read parameters and store in corresponding variables
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Target chain ID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dstServiceID</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Own chaincode ID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cid</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getChaincodeID</span><span class=p>(</span><span class=nx>stub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Get bxhID and appchainID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>curFullID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>genFullServiceID</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>cid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Combine current chain ID and target chain ID into output cross-chain service group
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>outServicePair</span> <span class=o>:=</span> <span class=nf>genServicePair</span><span class=p>(</span><span class=nx>curFullID</span><span class=p>,</span> <span class=nx>dstServiceID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Get key-value pairs of output values
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>outMeta</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>getMap</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>outterMeta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if the output cross-chain service group is in the key-value pair, if not, set to 0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>]</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Encapsulate transaction information
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tx</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Event</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Index</span><span class=p>:</span>     <span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>DstFullID</span><span class=p>:</span> <span class=nx>dstServiceID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>SrcFullID</span><span class=p>:</span> <span class=nx>curFullID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Func</span><span class=p>:</span>      <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>Args</span><span class=p>:</span>      <span class=nx>args</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>Argscb</span><span class=p>:</span>    <span class=nx>args</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nx>Argsrb</span><span class=p>:</span>    <span class=nx>args</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Output service self-increment
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>outMeta</span><span class=p>[</span><span class=nx>outServicePair</span><span class=p>]</span><span class=o>++</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Convert transaction information to json format
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>txValue</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Format output event message
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>key</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>outMsgKey</span><span class=p>(</span><span class=nx>outServicePair</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>FormatUint</span><span class=p>(</span><span class=nx>tx</span><span class=p>.</span><span class=nx>Index</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Write message and transaction information to the ledger (persistence)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>PutState</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>txValue</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;persist event: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set the corresponding cross-chain transaction event name and store the transaction information in the payload
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>SetEvent</span><span class=p>(</span><span class=nx>interchainEventName</span><span class=p>,</span> <span class=nx>txValue</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;set event: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Write metadata status to the ledger
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>broker</span><span class=p>.</span><span class=nf>putMap</span><span class=p>(</span><span class=nx>stub</span><span class=p>,</span> <span class=nx>outterMeta</span><span class=p>,</span> <span class=nx>outMeta</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Success</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is what happens when calling the cross-chain contract. Essentially, it just sets an event trigger through <code>SetEvent()</code> in the cross-chain contract, and then subscribes and monitors it in the plugin through <code>RegisterChaincodeEvent()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nf>SetEvent</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>payload</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>error</span>
</span></span></code></pre></div><p><code>SetEvent()</code> is an interface under the <code>shim</code> package, mainly passing in name and payload array. For details on chaincode event monitoring principles and details, please refer to &lt;<a href=https://www.pseudoyu.com/en/2021/09/01/blockchain_hyperledger_fabric_gosdk_event/>Hyperledger Fabric Go SDK Event Analysis</a>>.</p><h3 id=business-contract>Business Contract</h3><p>After analyzing the cross-chain contract, let&rsquo;s see how the business contract calls the cross-chain contract, taking the data exchange contract <code>data_swapper.go</code> in the example as an instance.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>DataSwapper</span><span class=p>)</span> <span class=nf>get</span><span class=p>(</span><span class=nx>stub</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>ChaincodeStubInterface</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// args[0]: key
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>value</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>GetState</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Success</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// args[0]: destination service id
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// args[1]: key
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>util</span><span class=p>.</span><span class=nf>ToChaincodeArgs</span><span class=p>(</span><span class=nx>emitInterchainEventFunc</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&#34;interchainGet,interchainSet,&#34;</span><span class=p>,</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>response</span> <span class=o>:=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>InvokeChaincode</span><span class=p>(</span><span class=nx>brokerContractName</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>channelID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Status</span> <span class=o>!=</span> <span class=nx>shim</span><span class=p>.</span><span class=nx>OK</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invoke broker chaincode %s error: %s&#34;</span><span class=p>,</span> <span class=nx>brokerContractName</span><span class=p>,</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Message</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Success</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>shim</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=s>&#34;incorrect number of arguments&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>To get information from other chains in the <code>data_swapper.go</code> business contract, it first judges the length of the input parameter array <code>args []string</code> through <code>switch...case...</code> when calling the <code>get</code> method. When the length is 1, it normally calls its own contract for query, and when the length is 2, it first uses the <code>ToChaincodeArgs()</code> method provided by Fabric to convert the parameters from <code>string</code> to chaincode parameter array format.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ToChaincodeArgs</span><span class=p>(</span><span class=nx>args</span> <span class=o>...</span><span class=kt>string</span><span class=p>)</span> <span class=p>[][]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>bargs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([][]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>arg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>args</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>bargs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>bargs</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Then, it directly calls the cross-chain contract through the <code>InvokeChaincode()</code> method in the business chaincode, and passes in parameters and channel ID, thus completing a cross-chain data query chaincode call.</p><h2 id=conclusion>Conclusion</h2><p>The above is an analysis of the cross-chain transaction process and BitXHub cross-chain plugin (Fabric) source code. I hope that through this process, I can deepen my understanding of cross-chain mechanisms and related platforms, and be able to better participate in its open-source construction in the future.</p><h2 id=references>References</h2><blockquote><ol><li><a href=https://github.com/gocn/opentalk/tree/main/PhaseTen_BitXHub>Cross-chain Technology Platform BitXHub</a></li><li><a href=https://meshplus.github.io/bitxhub/bitxhub/introduction/summary/>BitXHub Document</a></li><li><a href=https://github.com/meshplus/pier-client-fabric>meshplus/pier-client-fabric</a></li><li><a href=https://tech.hyperchain.cn/bitxhub-design-thinking/>Ten Questions about BitXHub: Discussing the Architecture Design of Cross-chain Platforms</a></li><li><a href=https://github.com/meshplus/bitxhub/wiki/%E8%B7%A8%E9%93%BE%E5%90%88%E7%BA%A6%E7%BC%96%E5%86%99%E6%96%87%E6%A1%A3>Cross-chain Contract Writing Documentation</a></li><li><a href=https://www.pseudoyu.com/en/2021/09/01/blockchain_hyperledger_fabric_gosdk_event/>Hyperledger Fabric Go SDK Event Analysis</a></li></ol></blockquote></articl><h2>Related Posts</h2><dl class=row></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-02-10</dt><dd class=col-md-9><a href=/en/2023/02/10/cosmos_introduction_and_explaination/>Cosmos Blockchain Architecture and Tendermint Consensus Mechanism</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2021-09-07</dt><dd class=col-md-9><a href=/en/2021/09/07/blockchain_baas_platform/>Introduction and Architecture of Blockchain as a Service (BaaS) Platforms</a></dd></dl><dt class=col-md-3>2021-09-06</dt><dd class=col-md-9><a href=/en/2021/09/06/blockchain_crosschain/>Cross-Chain Technology Principles and Practice</a></dd></dl></dl><dt class=col-md-3>2021-09-01</dt><dd class=col-md-9><a href=/en/2021/09/01/blockchain_hyperledger_fabric_gosdk_event/>Hyperledger Fabric Go SDK Event Analysis</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2021-03-23</dt><dd class=col-md-9><a href=/en/2021/03/23/blockchain_hyperledger_fabric_network/>A Brief Analysis of Hyperledger Fabric Network and Security System</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://www.pseudoyu.com><img src=/images/author.webp alt=pseudoyu></a></div><div class=author-content><p class=author-title>Author</p><p class=author-name>pseudoyu</p><p class=author-desc>Backend & Smart Contract Developer, MSc Graduate in ECIC(Electronic Commerce and Internet Computing) @ The University of Hong Kong (HKU). Love to learn and build things. <a href=https://github.com/pseudoyu>Follow me on GitHub</a></p></div></div></div><div align=center><div class=comment-underline></div></div><br><div class=comments><div class=title><span>Comments</span>
<span class=counter><span class=remark42__counter data-url=https://www.pseudoyu.com/en/2021/09/09/blockchain_crosschain_bitxhub/></span></span></div><div id=remark42></div></div><script>var remark_config={host:"https://comments.pseudoyu.com",site_id:"pseudoyu.com",components:["embed","counter"],max_shown_comments:20,simple_view:!0,theme:"light"}</script><script>(function(){const t=window.REMARK42;if(t)t.destroy(),t.createInstance(remark_config);else for(const t of remark_config.components){var n=document,e=n.createElement("script");e.src=`${remark_config.host}/web/${t}.mjs`,e.type="module",e.defer=!0,e.setAttribute("data-no-instant",""),n.head.appendChild(e)}})()</script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Sitemap</div><ul class=list-unstyled><li><a href=https://www.pseudoyu.com/en/tags/>Tags</a></li><li><a href=https://www.pseudoyu.com/en/categories/>Categories</a></li><li><a rel=alternate type=application/rss+xml href=https://www.pseudoyu.com/en/index.xml><i class="fas fa-rss-square"></i> RSS Feed</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Social</div><ul class=list-unstyled><li><a href=https://t.me/pseudoyulife rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/pseudo_yu rel=noopener target=_blank>Twitter</a></li><li><a href=https://www.instagram.com/pseudo.yu/ rel=noopener target=_blank>Instagram</a></li><li><a href=https://space.bilibili.com/5374948/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Links</div><ul class=list-unstyled><li><a href=https://github.com/pseudoyu rel=noopener target=_blank>Yu's GitHub</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em><a href="https://stats.pseudoyu.com?access-token=2m1u5i2k413q0733h2a3332w3m1t6r634g1m6n" rel=noopener target=_blank>Yu's blog analytics</a></em></small><br><small><em>Powered by <a href=https://gohugo.io rel=noopener target=_blank>Hugo</a> - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>den</a></em></small><br><small><em><a href=https://www.hku.hk rel=noopener target=_blank>The University of Hong Kong</a> - <a href=https://www.cs.hku.hk rel=noopener target=_blank>CS</a></em></small><br><small>&copy;
Yu Zhang
2020 -
2024</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>