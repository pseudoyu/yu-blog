<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.105.0"><meta charset=utf-8><title>Implementing Two-Phase Commit in Solidity Smart Contracts Using State Locks · Pseudoyu</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script data-goatcounter=https://stats.pseudoyu.com/count async src=//stats.pseudoyu.com/count.js></script><meta name=description content="《后来的我们 - 五月天》 Preface In smart contract applications involving interactions between multiple systems or contracts, particularly in businesses where asset or data accuracy is sensitive, we need to ensure data atomicity throughout the entire business process. Therefore, we need to implement a mechanism similar to multi-phase commit at the contract level, which decomposes the state change process in the contract into two"><meta name=keywords content="hugo,blockchain,programming"><link rel=canonical href=https://www.pseudoyu.com/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/><link rel=alternate href=https://www.pseudoyu.com/zh/2022/07/01/two_phase_commit_contract_practice_in_solidity/ hreflang=zh><link rel=alternate href=https://www.pseudoyu.com/de/2022/07/01/two_phase_commit_contract_practice_in_solidity/ hreflang=de><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://www.pseudoyu.com/css/den.css><link rel=stylesheet href=https://www.pseudoyu.com/css/custom.css><meta property="og:title" content="Implementing Two-Phase Commit in Solidity Smart Contracts Using State Locks"><meta property="og:description" content="《后来的我们 - 五月天》 Preface In smart contract applications involving interactions between multiple systems or contracts, particularly in businesses where asset or data accuracy is sensitive, we need to ensure data atomicity throughout the entire business process. Therefore, we need to implement a mechanism similar to multi-phase commit at the contract level, which decomposes the state change process in the contract into two"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-01T10:54:57+08:00"><meta property="article:modified_time" content="2022-07-01T10:54:57+08:00"><meta itemprop=name content="Implementing Two-Phase Commit in Solidity Smart Contracts Using State Locks"><meta itemprop=description content="《后来的我们 - 五月天》 Preface In smart contract applications involving interactions between multiple systems or contracts, particularly in businesses where asset or data accuracy is sensitive, we need to ensure data atomicity throughout the entire business process. Therefore, we need to implement a mechanism similar to multi-phase commit at the contract level, which decomposes the state change process in the contract into two"><meta itemprop=datePublished content="2022-07-01T10:54:57+08:00"><meta itemprop=dateModified content="2022-07-01T10:54:57+08:00"><meta itemprop=wordCount content="1057"><meta itemprop=keywords content="blockchain,ethereum,solidity,smart contract,web3,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementing Two-Phase Commit in Solidity Smart Contracts Using State Locks"><meta name=twitter:description content="《后来的我们 - 五月天》 Preface In smart contract applications involving interactions between multiple systems or contracts, particularly in businesses where asset or data accuracy is sensitive, we need to ensure data atomicity throughout the entire business process. Therefore, we need to implement a mechanism similar to multi-phase commit at the contract level, which decomposes the state change process in the contract into two"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.pseudoyu.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.pseudoyu.com/en/><img class="mr20 header-logo-image" src=https://image.pseudoyu.com/images/fly.png alt=logo>
Pseudoyu</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/ideas/>Idea</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/tools/>Tool</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/develop/>Develop</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/links/>Links</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/about/>About</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/search/>Search</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/><i class="fas fa-globe"></i> 简</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/de/><i class="fas fa-globe"></i> DE</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>Implementing Two-Phase Commit in Solidity Smart Contracts Using State Locks</h1><p class=header-date>Author:
pseudoyu
| <span>1057 words, 3 minutes</span>
| <span class=remark42__counter data-url=https://www.pseudoyu.com/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/></span> comments
| 2022-07-01
| Category:
<a href=https://www.pseudoyu.com/en/category/develop/>Develop</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.pseudoyu.com/en/tag/blockchain/>blockchain</a>,
<a href=https://www.pseudoyu.com/en/tag/ethereum/>ethereum</a>,
<a href=https://www.pseudoyu.com/en/tag/smart-contract/>smart contract</a>,
<a href=https://www.pseudoyu.com/en/tag/solidity/>solidity</a>,
<a href=https://www.pseudoyu.com/en/tag/web3/>web3</a></p><div class=clearfix></div><p class="float-right translations"><i class="fas fa-language" aria-hidden=true></i>
Translations:
<a href=https://www.pseudoyu.com/zh/2022/07/01/two_phase_commit_contract_practice_in_solidity/>ZH</a>, <a href=https://www.pseudoyu.com/de/2022/07/01/two_phase_commit_contract_practice_in_solidity/>DE</a></p></div></div></div></div></div><main><div class="container content"><articl data-pagefind-body><figure><audio controls preload=metadata><source src=/audios/here_after_us.mp3 type=audio/mpeg></audio><i><figcaption>《后来的我们 - 五月天》</figcaption></i></figure><h2 id=preface>Preface</h2><p>In smart contract applications involving interactions between multiple systems or contracts, particularly in businesses where asset or data accuracy is sensitive, we need to ensure data atomicity throughout the entire business process. Therefore, we need to implement a mechanism similar to multi-phase commit at the contract level, which decomposes the state change process in the contract into two phases: pre-commit and formal commit.</p><p>This article implements a minimalistic two-phase commit model using a state lock mechanism. The complete contract code can be found at <a href=https://github.com/pseudoyu/learn-solidity/blob/master/practice/two_phase_commit/TwoPhaseCommit.sol>TwoPhaseCommit.sol</a>. The following will explain the core logic of this contract and strive to follow style guidelines and best practices.</p><blockquote><p>Note: This contract was primarily designed for business use in consortium chains and has not been specifically optimized for gas fees. It is intended for learning purposes only.</p></blockquote><h2 id=contract-logic>Contract Logic</h2><h3 id=contract-structure>Contract Structure</h3><p>The two-phase commit scenario includes the following methods:</p><ol><li>set: Two-phase - Pre-commit</li><li>commit: Two-phase - Formal commit</li><li>rollback: Two-phase - Rollback</li></ol><p>Due to Solidity language limitations on string length judgment and comparison, to enhance the readability of the contract code, this contract provides some auxiliary methods, mainly including:</p><ol><li>isValidKey: Check if the key is valid</li><li>isValidValue: Check if the value is valid</li><li>isEqualString: Compare if two strings are equal</li></ol><h3 id=two-phase-commit-core-logic>Two-Phase Commit Core Logic</h3><p>In the two-phase commit scenario, this contract provides a simple set of <code>set</code>, <code>commit</code>, and <code>rollback</code> methods to store key-value pairs passed in contract calls on the chain. We use a state lock mechanism to achieve atomicity of cross-chain transactions. We define the following data structures:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>enum</span> <span class=nc>State</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>UNLOCKED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LOCKED</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>struct</span> <span class=nc>Payload</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>State</span> <span class=n>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>lockValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here, <code>State</code> is an enumeration type that records the lock status of the key on the chain, while the <code>Payload</code> structure stores the lock status, current value, and the value being locked. It is bound to the key through the following <code>mapping</code> structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>mapping</span> <span class=p>(</span><span class=kt>string</span> <span class=o>=&gt;</span> <span class=n>Payload</span><span class=p>)</span> <span class=n>keyToPayload</span><span class=p>;</span>
</span></span></code></pre></div><p>Thus, we can track the state of each key in the contract call based on <code>keyToPayload</code>, and check the state of the key in the following <code>set</code>, <code>commit</code>, and <code>rollback</code> methods for exception handling.</p><h4 id=set>set()</h4><p>In the <code>set()</code> method, we check the state of the key. If it is <code>State.LOCKED</code>, storage will not be performed and an exception will be thrown:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>LOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If it is <code>State.UNLOCKED</code>, the value passed in the contract call will be stored in lockValue, and its state will be set to <code>LOCKED</code>, waiting for subsequent <code>commit</code> or <code>rollback</code> to unlock.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>State</span><span class=p>.</span><span class=n>LOCKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span></code></pre></div><h4 id=commit>commit()</h4><p>In the <code>commit()</code> method, we check the state of the key. If it is <code>State.UNLOCKED</code>, no operation will be performed on this key and an exception will be thrown:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If it is <code>State.LOCKED</code>, we check if the value passed in the contract call is equal to lockValue. If not equal, an exception is thrown:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isEqualString</span><span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span><span class=p>,</span> <span class=n>_value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If the values are equal, the value corresponding to this key will be stored on the chain, the state of the key will be set to <code>UNLOCKED</code>, the current value <code>value</code> will be updated, and <code>lockValue</code> will be emptied:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>store</span><span class=p>[</span><span class=n>_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=nb>value</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span></code></pre></div><h4 id=rollback>rollback()</h4><p>In the <code>rollback()</code> method, we check the state of the key. If it is <code>State.UNLOCKED</code>, no operation will be performed on this key and an exception will be thrown:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If it is <code>State.LOCKED</code>, we check if the value passed in the contract call is equal to lockValue. If not equal, an exception is thrown:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isEqualString</span><span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span><span class=p>,</span> <span class=n>_value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If the values are equal, the state of the key will be set to <code>UNLOCKED</code>, and <code>lockValue</code> will be emptied:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>=</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=error-handling-logic>Error Handling Logic</h3><p>In contract execution exception scenarios, we throw errors and perform rollbacks. To better improve the readability of error messages and facilitate error capture and handling by upper-layer application personnel, we adopted the error type definition approach, defining various exception scenarios. Since I have already included most of the information in the error naming, no additional parameter values for error types have been defined, which can be customized according to requirements.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataKeyIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataValueIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsNotExist</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>error</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span></code></pre></div><p>In specific contract logic, we throw exceptions using the <code>revert</code> method, such as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidKey</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_key</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataKeyIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidValue</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_value</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataValueIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>state</span> <span class=o>==</span> <span class=n>State</span><span class=p>.</span><span class=n>UNLOCKED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotLocked</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isEqualString</span><span class=p>(</span><span class=n>keyToPayload</span><span class=p>[</span><span class=n>_key</span><span class=p>].</span><span class=n>lockValue</span><span class=p>,</span> <span class=n>_value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsInconsistent</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=generic-parameter-validation>Generic Parameter Validation</h3><p>We perform some validity checks on input parameters. To provide extensibility, we use the <code>isValidKey()</code> and <code>isValidValue()</code> methods to independently validate keys and values:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @notice Data key format validation
</span></span></span><span class=line><span class=cl><span class=cm> * @param _key Data - Key
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nf>isValidKey</span><span class=p>(</span><span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_key</span><span class=p>)</span> <span class=k>private</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=n>key</span> <span class=o>=</span> <span class=n>_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=n>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @notice Data value format validation
</span></span></span><span class=line><span class=cl><span class=cm> * @param _value Data - Value
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nf>isValidValue</span><span class=p>(</span><span class=kt>bytes</span> <span class=k>memory</span> <span class=n>_value</span><span class=p>)</span> <span class=k>private</span> <span class=k>pure</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bytes</span> <span class=k>memory</span> <span class=nb>value</span> <span class=o>=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>value</span><span class=p>.</span><span class=n>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This contract only performs non-null checks. You can customize business logic according to business needs and call it where validation is needed, such as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidKey</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_key</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataKeyIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidValue</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>_value</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataValueIsNull</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isValidValue</span><span class=p>(</span><span class=kt>bytes</span><span class=p>(</span><span class=n>store</span><span class=p>[</span><span class=n>_key</span><span class=p>])))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>revert</span> <span class=n>TwoPhaseCommit__DataIsNotExist</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=event-mechanism>Event Mechanism</h3><p>Additionally, we defined events corresponding to core methods and set indexed for events to facilitate monitoring and processing by upper-layer applications.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>event</span> <span class=nc>setEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>event</span> <span class=nc>getEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>event</span> <span class=nc>commitEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>event</span> <span class=nc>rollbackEvent</span><span class=p>(</span><span class=kt>string</span> <span class=k>indexed</span> <span class=n>key</span><span class=p>,</span> <span class=kt>string</span> <span class=k>indexed</span> <span class=nb>value</span><span class=p>);</span>
</span></span></code></pre></div><p>Events are emitted in contract methods using the <code>emit()</code> method, such as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>emit</span> <span class=n>setEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>emit</span> <span class=n>getEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>emit</span> <span class=n>commitEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>emit</span> <span class=n>rollbackEvent</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>The above is a best practice for my two-phase commit contract. For basic Solidity syntax, please refer to &ldquo;<a href=https://www.pseudoyu.com/en/2022/05/25/learn_solidity_from_scratch_basic/>Solidity Smart Contract Development - Basics</a>&rdquo;. I will continue to practice and explain more contract scenarios in the future, so stay tuned.</p><h2 id=references>References</h2><blockquote><ol><li><a href=https://github.com/pseudoyu/learn-solidity/blob/master/practice/two_phase_commit/TwoPhaseCommit.sol>TwoPhaseCommit.sol Contract Source Code</a></li><li><a href=https://www.pseudoyu.com/en/2022/05/25/learn_solidity_from_scratch_basic/>Solidity Smart Contract Development - Basics</a></li><li><a href=https://docs.soliditylang.org/en/v0.8.15/>Solidity Official Documentation</a></li></ol></blockquote></articl><h2>Related Posts</h2><dl class=row></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-09-13</dt><dd class=col-md-9><a href=/en/2023/09/13/weekly_review_20230913/>Weekly Review #46 - Farewell to Long Hair, Weekly Review's Original Intention, and Contract Development</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-04-30</dt><dd class=col-md-9><a href=/en/2023/04/30/weekly_review_20230430/>Weekly Review #38 - Foundry Contract Testing, Logseq Task Management, and Surge Ponte Remote Development</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-06-09</dt><dd class=col-md-9><a href=/en/2022/06/09/learn_solidity_from_scratch_hardhat/>Solidity Smart Contract Development - Using the Hardhat Framework</a></dd></dl></dl><dt class=col-md-3>2022-06-08</dt><dd class=col-md-9><a href=/en/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity Smart Contract Development - Mastering ethers.js</a></dd></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-05-30</dt><dd class=col-md-9><a href=/en/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity Smart Contract Development - Mastering Web3.py</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://www.pseudoyu.com><img src=/images/author.webp alt=pseudoyu></a></div><div class=author-content><p class=author-title>Author</p><p class=author-name>pseudoyu</p><p class=author-desc>Backend & Smart Contract Developer, MSc Graduate in ECIC(Electronic Commerce and Internet Computing) @ The University of Hong Kong (HKU). Love to learn and build things. <a href=https://github.com/pseudoyu>Follow me on GitHub</a></p></div></div></div><div align=center><div class=comment-underline></div></div><br><div class=comments><div class=title><span>Comments</span>
<span class=counter><span class=remark42__counter data-url=https://www.pseudoyu.com/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/></span></span></div><div id=remark42></div></div><script>var remark_config={host:"https://comments.pseudoyu.com",site_id:"pseudoyu.com",components:["embed","counter"],max_shown_comments:20,simple_view:!0,theme:"light"}</script><script>(function(){const t=window.REMARK42;if(t)t.destroy(),t.createInstance(remark_config);else for(const t of remark_config.components){var n=document,e=n.createElement("script");e.src=`${remark_config.host}/web/${t}.mjs`,e.type="module",e.defer=!0,e.setAttribute("data-no-instant",""),n.head.appendChild(e)}})()</script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Sitemap</div><ul class=list-unstyled><li><a href=https://www.pseudoyu.com/en/tags/>Tags</a></li><li><a href=https://www.pseudoyu.com/en/categories/>Categories</a></li><li><a rel=alternate type=application/rss+xml href=https://www.pseudoyu.com/en/index.xml><i class="fas fa-rss-square"></i> RSS Feed</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Social</div><ul class=list-unstyled><li><a href=https://t.me/pseudoyulife rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/pseudo_yu rel=noopener target=_blank>Twitter</a></li><li><a href=https://www.instagram.com/pseudo.yu/ rel=noopener target=_blank>Instagram</a></li><li><a href=https://space.bilibili.com/5374948/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Links</div><ul class=list-unstyled><li><a href=https://github.com/pseudoyu rel=noopener target=_blank>Yu's GitHub</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em><a href="https://stats.pseudoyu.com?access-token=2m1u5i2k413q0733h2a3332w3m1t6r634g1m6n" rel=noopener target=_blank>Yu's blog analytics</a></em></small><br><small><em>Powered by <a href=https://gohugo.io rel=noopener target=_blank>Hugo</a> - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>den</a></em></small><br><small><em><a href=https://www.hku.hk rel=noopener target=_blank>The University of Hong Kong</a> - <a href=https://www.cs.hku.hk rel=noopener target=_blank>CS</a></em></small><br><small>&copy;
Yu Zhang
2020 -
2024</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>