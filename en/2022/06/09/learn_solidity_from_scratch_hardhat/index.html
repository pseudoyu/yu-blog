<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.105.0"><meta charset=utf-8><title>Solidity 智能合约开发 - Hardhat 框架使用 · Pseudoyu</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async defer data-website-id=058488c2-18d4-498a-b683-0a898b3f6c7a src=https://data.pseudoyu.com/pseudoyu.js></script>
<script async src=https://cdn.splitbee.io/sb.js></script>
<script src=https://cdn.splitbee.io/sb-ab.js></script><meta name=description content="《后来的我们 - 五月天》 前言 经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的"><meta name=keywords content="hugo,blockchain,programming"><link rel=canonical href=https://www.pseudoyu.com/en/2022/06/09/learn_solidity_from_scratch_hardhat/><link rel=alternate href=https://www.pseudoyu.com/zh/2022/06/09/learn_solidity_from_scratch_hardhat/ hreflang=zh><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href=https://www.pseudoyu.com/css/den.css><link rel=stylesheet href=https://www.pseudoyu.com/css/custom.css><meta property="og:title" content="Solidity 智能合约开发 - Hardhat 框架使用"><meta property="og:description" content="《后来的我们 - 五月天》 前言 经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pseudoyu.com/en/2022/06/09/learn_solidity_from_scratch_hardhat/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-09T14:38:10+08:00"><meta property="article:modified_time" content="2022-06-09T14:38:10+08:00"><meta itemprop=name content="Solidity 智能合约开发 - Hardhat 框架使用"><meta itemprop=description content="《后来的我们 - 五月天》 前言 经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的"><meta itemprop=datePublished content="2022-06-09T14:38:10+08:00"><meta itemprop=dateModified content="2022-06-09T14:38:10+08:00"><meta itemprop=wordCount content="3553"><meta itemprop=keywords content="blockchain,solidity,ethereum,web3,smart contract,javascript,ethers.js,hardhat,yarn,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Solidity 智能合约开发 - Hardhat 框架使用"><meta name=twitter:description content="《后来的我们 - 五月天》 前言 经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://www.pseudoyu.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://www.pseudoyu.com/en/><img class="mr20 header-logo-image" src=https://www.pseudoyu.com/images/fly.png alt=logo>
Pseudoyu</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/ideas/>Idea</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/tools/>Tool</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/category/develop/>Develop</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/links/>Links</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/about/>About</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/en/search/>Search</a></li><li class=nav-item><a class=nav-link href=https://www.pseudoyu.com/zh/><i class="fas fa-globe"></i> 中文</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>Solidity 智能合约开发 - Hardhat 框架使用</h1><p class=header-date>Author:
pseudoyu
| <span>3553 words, 8 minutes</span>
| <span data-cusdis-count-page-id=57ca604e2bba11fd70217832c3223fea>0</span> comments
| 2022-06-09
| Category:
<a href=https://www.pseudoyu.com/en/category/develop/>Develop</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://www.pseudoyu.com/en/tag/blockchain/>blockchain</a>,
<a href=https://www.pseudoyu.com/en/tag/ethereum/>ethereum</a>,
<a href=https://www.pseudoyu.com/en/tag/ethers.js/>ethers.js</a>,
<a href=https://www.pseudoyu.com/en/tag/hardhat/>hardhat</a>,
<a href=https://www.pseudoyu.com/en/tag/javascript/>javascript</a>,
<a href=https://www.pseudoyu.com/en/tag/smart-contract/>smart contract</a>,
<a href=https://www.pseudoyu.com/en/tag/solidity/>solidity</a>,
<a href=https://www.pseudoyu.com/en/tag/web3/>web3</a>,
<a href=https://www.pseudoyu.com/en/tag/yarn/>yarn</a></p><div class=clearfix></div><p class="float-right translations"><i class="fas fa-language" aria-hidden=true></i>
Translations:
<a href=https://www.pseudoyu.com/zh/2022/06/09/learn_solidity_from_scratch_hardhat/>ZH</a></p></div></div></div></div></div><main><div class="container content"><articl data-pagefind-body><figure><audio controls preload=metadata><source src=/audios/here_after_us.mp3 type=audio/mpeg></audio><i><figcaption>《后来的我们 - 五月天》</figcaption></i></figure><h2 id=前言>前言</h2><p>经过了前几篇对智能合约基础、Web3.py、ethers.js 的学习，我们已经掌握了通过程序与区块链网络直接交互的基础知识，不熟悉的同学可以回顾一下：</p><ul><li><a href=https://www.pseudoyu.com/en/2022/05/25/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=https://www.pseudoyu.com/en/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity 智能合约开发 - 玩转 Web3.py</a></li><li><a href=https://www.pseudoyu.com/en/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></li></ul><p>但是在真正的复杂业务场景中，我们往往会使用一些进一步封装的框架，如 HardHat、Brownie、Truffle 等，HardHat 是其中应用最广泛、插件拓展最为强大的。本系列将从这篇开始专注于 Hardhat 框架的使用与最佳实践，而本篇则会通过一个简单的例子完成其安装、配置与使用。</p><p>本文是对 <a href=https://twitter.com/PatrickAlphaC>Patrick Collins</a> 的 『<a href="https://www.youtube.com/watch?v=gyMwXuJrbJQ">Learn Blockchain, Solidity, and Full Stack Web3 Development with JavaScript</a>』 教程的学习整理，强烈建议看原教程视频了解更多细节。</p><p>可以点击<a href=https://github.com/pseudoyu/learn-solidity/tree/master/hardhat_simple_storage>这里</a>访问本测试 Demo 代码仓库。</p><h2 id=hardhat-介绍>Hardhat 介绍</h2><p><img src=https://image.pseudoyu.com/images/hardhat_homepage.png alt=hardhat_homepage></p><p>Hardhat 是一个基于 JavaScript 的智能合约开发环境，可以用于灵活地编译、部署、测试和调试基于 EVM 的智能合约，并且提供了一系列工具链来整合代码与外部工具，还提供了丰富的插件生态，提升开发效率。此外，它还提供了模拟以太坊的本地 Hardhat 网络节点，提供强大的本地调试功能。</p><p>其 GitHub 地址为 <a href=https://github.com/NomicFoundation/hardhat>NomicFoundation/hardhat</a>，可以访问其<a href=https://hardhat.org/getting-started>官方文档</a>了解更多。</p><h2 id=hardhat-使用>Hardhat 使用</h2><h3 id=初始化项目>初始化项目</h3><p>从零开始搭建一个 Hardhat 项目，我们需要预先安装好 <code>node.js</code> 与 <code>yarn</code> 环境，这部份参照官方说明根据自己的系统环境按照即可。</p><p>首先，我们需要初始化项目并安装 <code>hardhat</code> 依赖包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn init
</span></span><span class=line><span class=cl>yarn add --dev hardhat
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/yarn_add.png alt=yarn_add></p><h3 id=初始化-hardhat>初始化 Hardhat</h3><p>然后需要运行 <code>yarn hardhat</code>，通过交互式命令来进行初始化，根据项目需要进行配置，我们的测试 Demo 选择默认值。</p><p><img src=https://image.pseudoyu.com/images/hardhat_project_init.png alt=hardhat_project_init></p><h3 id=优化代码格式化>优化代码格式化</h3><h4 id=vs-code-配置>VS Code 配置</h4><p>我本地是通过 VS Code 进行代码开发的，可以通过安装 <code>Solidity + Hardhat</code> 与 <code>Prettier</code> 两个插件来进行代码格式化，可以使用打开 VS Code 设置，在 <code>settings.json</code> 中增加如下格式化配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;[solidity]&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;editor.defaultFormatter&#34;</span><span class=p>:</span> <span class=s2>&#34;NomicFoundation.hardhat-solidity&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;[javascript]&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;editor.defaultFormatter&#34;</span><span class=p>:</span> <span class=s2>&#34;esbenp.prettier-vscode&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=项目配置>项目配置</h4><p>为了统一各个使用项目的开发人员的代码格式化样式，我们还可以为项目配置 <code>prettier</code> 与 <code>prettier-plugin-solidity</code> 插件支持：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn add --dev prettier prettier-plugin-solidity
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/yarn_add_prettier_plugin.png alt=yarn_add_prettier_plugin></p><p>添加依赖后，可以在项目目录增加 <code>.prettierrc</code> 与 <code>.prettierignore</code> 配置文件来进行格式化统一：</p><p>我的 <code>.prettierrc</code> 配置为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tabWidth&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;useTabs&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;semi&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;singleQuote&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我的 <code>.prettierignore</code> 配置为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>node_modules
</span></span><span class=line><span class=cl>package.json
</span></span><span class=line><span class=cl>img
</span></span><span class=line><span class=cl>artifacts
</span></span><span class=line><span class=cl>cache
</span></span><span class=line><span class=cl>coverage
</span></span><span class=line><span class=cl>.env
</span></span><span class=line><span class=cl>.*
</span></span><span class=line><span class=cl>README.md
</span></span><span class=line><span class=cl>coverage.json
</span></span></code></pre></div><h3 id=编译合约>编译合约</h3><p>无需像 <code>ethers.js</code> 一样自定义 <code>compile</code> 命令，HardHat 预置了 <code>compile</code> 命令，可以将合约放在 <code>contracts</code> 目录下，然后通过 <code>yarn hardhat compile</code> 命令来编译合约：</p><p><img src=https://image.pseudoyu.com/images/hardhat_compile_contract.png alt=hardhat_compile_contract></p><h3 id=添加-dotenv-支持>添加 <code>dotenv</code> 支持</h3><p>在开始编写部署脚本之前，我们先配置一下 <code>dotenv</code> 插件，这样我们就可以使用 <code>dotenv</code> 来获取环境变量。我们在开发过程中，会牵扯到很多隐私信息，如私钥等，我们会希望将其存储在 <code>.env</code> 文件或直接设置在终端中，比如我们的 <code>RINKEBY_PRIVATE_TOKEN</code>，这样我们就可以在部署脚本中使用 <code>process.env.RINKEBY_PRIVATE_TOKEN</code> 获取到值，无需在代码中显式写入，减少隐私泄漏风险。</p><h4 id=安装-dotenv>安装 <code>dotenv</code></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn add --dev dotenv
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/yarn_add_dotenv.png alt=yarn_add_dotenv></p><h4 id=设置环境变量>设置环境变量</h4><p>在 <code>.env</code> 文件中，我们可以设置环境变量，比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>RINKEBY_RPC_URL=url
</span></span><span class=line><span class=cl>RINKEBY_PRIVATE_KEY=0xkey
</span></span><span class=line><span class=cl>ETHERSCAN_API_KEY=key
</span></span><span class=line><span class=cl>COINMARKETCAP_API_KEY=key
</span></span></code></pre></div><p>我们就可以在 <code>hardhat.config.js</code> 中读取环境变量了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;dotenv&#34;</span><span class=p>).</span><span class=nx>config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RINKEBY_RPC_URL</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>RINKEBY_RPC_URL</span> <span class=o>||</span> <span class=s2>&#34;https://eth-rinkeby/example&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RINKEBY_PRIVATE_KEY</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>RINKEBY_PRIVATE_KEY</span> <span class=o>||</span> <span class=s2>&#34;0xkey&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>ETHERSCAN_API_KEY</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ETHERSCAN_API_KEY</span> <span class=o>||</span> <span class=s2>&#34;key&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>COINMARKETCAP_API_KEY</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>COINMARKETCAP_API_KEY</span> <span class=o>||</span> <span class=s2>&#34;key&#34;</span>
</span></span></code></pre></div><h3 id=配置网络环境>配置网络环境</h3><p>往往我们的合约需要运行在不同的区块链网络上，如本地测试、开发、上线环境等等，Hardhat 也提供了便捷的方式来配置网络环境。</p><h4 id=启动网络>启动网络</h4><p>我们可以直接运行脚本来启动一个 Hardhat 自带的网络，但该网络仅仅存活于脚本运行期间，想要启动一个本地可持续的网络，需要运行 <code>yarn hardhat node</code> 命令：</p><p><img src=https://image.pseudoyu.com/images/hardhat_localhost_node.png alt=hardhat_localhost_node></p><p>执行完成后，就生成了测试网络与测试账户，供后续开发调试使用。</p><p>我们还可以通过 Alchemy 或 Infura 等平台生成自己的测试网节点，记录其 <code>RPC_URL</code> 供程序连接使用。</p><h4 id=定义网络>定义网络</h4><p>完成网络环境准备后，我们可以在项目配置 <code>hardhat.config.js</code> 中定义网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RINKEBY_RPC_URL</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>RINKEBY_RPC_URL</span> <span class=o>||</span> <span class=s2>&#34;https://eth-rinkeby/example&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RINKEBY_PRIVATE_KEY</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>RINKEBY_PRIVATE_KEY</span> <span class=o>||</span> <span class=s2>&#34;0xkey&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>defaultNetwork</span><span class=o>:</span> <span class=s2>&#34;hardhat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>networks</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>locakhost</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;http://localhost:8545&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>chainId</span><span class=o>:</span> <span class=mi>31337</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>rinkeby</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>url</span><span class=o>:</span> <span class=nx>RINKEBY_RPC_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>accounts</span><span class=o>:</span> <span class=p>[</span><span class=nx>RINKEBY_PRIVATE_KEY</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nx>chainId</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...,
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h3 id=脚本>脚本</h3><p>在 Hardhat 项目中，我们可以通过在 <code>scripts</code> 目录中编写脚本来实现部署等功能，并且通过便捷的命令执行脚本。</p><h4 id=编写部署脚本>编写部署脚本</h4><p>接下来我们开始编写 <code>deploy.js</code> 脚本。</p><p>首先，我们需要从 <code>hardhat</code> 中导入必要包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>ethers</span><span class=p>,</span> <span class=nx>run</span><span class=p>,</span> <span class=nx>network</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;hardhat&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>接着则编写 <code>main</code> 方法，包含我们的部署核心逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>SimpleStorageFactory</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>ethers</span><span class=p>.</span><span class=nx>getContractFactory</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SimpleStorage&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Deploying SimpleStorage Contract...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>simpleStorage</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>SimpleStorageFactory</span><span class=p>.</span><span class=nx>deploy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>deployed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;SimpleStorage Contract deployed at:&#34;</span><span class=p>,</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取当前值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>currentValue</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>retrieve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Current value:&#34;</span><span class=p>,</span> <span class=nx>currentValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>transactionResponse</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>store</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>transactionResponse</span><span class=p>.</span><span class=nx>wait</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取更新后的值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updatedValue</span> <span class=o>=</span> <span class=kr>await</span> <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>retrieve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Updated value:&#34;</span><span class=p>,</span> <span class=nx>updatedValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>最后运行我们的 <code>main</code> 方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></div><h4 id=运行脚本>运行脚本</h4><p>完成脚本编写后，可以通过 Hardhat 提供的 <code>run</code> 命令来运行脚本。</p><p>如不加网络参数，则默认使用 <code>hardhat</code> 网络，可以通过 <code>--network</code> 参数指定网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn hardhat run scripts/deploy.js --network rinkeby
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/hardhat_deploy_rinkeby.png alt=hardhat_deploy_rinkeby></p><h3 id=增加-etherscan-合约验证支持>增加 etherscan 合约验证支持</h3><p>将合约部署至 Rinkeby 测试网络后可在 Etherscan 上查看合约的地址，并且进行验证。我们可以通过网站进行操作，但 Hardhat 提供了插件支持，更方便进行验证操作。</p><h4 id=安装-hardhat-etherscan-插件>安装 hardhat-etherscan 插件</h4><p>我们通过 <code>yarn add --dev @nomiclabs/hardhat-etherscan</code> 命令安装插件。</p><p><img src=https://image.pseudoyu.com/images/yarn_add_etherscan_verify_support.png alt=yarn_add_etherscan_verify_support></p><h4 id=启用-etherscan-合约验证支持>启用 etherscan 合约验证支持</h4><p>完成安装后，我们需要在 <code>hardhat.config.js</code> 中进行配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;@nomiclabs/hardhat-etherscan&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>etherscan</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>apiKey</span><span class=o>:</span> <span class=nx>ETHERSCAN_API_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...,
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h4 id=定义-verify-方法>定义 verify 方法</h4><p>接下来我们需要在部署脚本 <code>deploy.js</code> 中添加 <code>verify</code> 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>ethers</span><span class=p>,</span> <span class=nx>run</span><span class=p>,</span> <span class=nx>network</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;hardhat&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>verify</span><span class=p>(</span><span class=nx>contractAddress</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Verifying SimpleStorage Contract...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>run</span><span class=p>(</span><span class=s2>&#34;verify:verify&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>address</span><span class=o>:</span> <span class=nx>contractAddress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>constructorArguements</span><span class=o>:</span> <span class=nx>args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>toLowerCase</span><span class=p>().</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;already verified!&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Already Verified!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这个方法我们调用了 <code>hardhat</code> 包中的 <code>run</code> 方法，并且传递了一个 <code>verify</code> 命令，并且传递了一个参数 <code>{ address: contractAddress, constructorArguements: args }</code>。因为可能我们的合约已经在 Etherscan 上验证过，所以我们做了一个 <code>try...catch...</code> 错误处理，如果验证过，则会抛出一个错误，并且输出一个提示信息，而不影响我们的部署流程。</p><h4 id=设置部署后调用>设置部署后调用</h4><p>定义好我们的 <code>verify</code> 方法后，我们可以在部署脚本中调用它：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>network</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>chainId</span> <span class=o>===</span> <span class=mi>4</span> <span class=o>&amp;&amp;</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ETHERSCAN_API_KEY</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>deployTransaction</span><span class=p>.</span><span class=nx>wait</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>verify</span><span class=p>(</span><span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>在这里我们做了两个特殊处理。</p><p>首先，我们仅需要在 <code>rinkeby</code> 网络上验证合约，而不需要在本地或其他网络环境验证，因此，我们对 <code>network.config.chainId</code> 进行判断，如果是 <code>4</code>，则执行验证操作；否则，不执行验证操作，此外仅在有 <code>ETHERSCAN_API_KEY</code> 环境变量时执行验证操作。</p><p>另外，Etherscan 可能需要在部署后一段时间才能获取到合约地址，因此我们配置了 <code>.wait(6)</code> 等待 6 个区块后再进行验证。</p><p>执行效果如下：</p><p><img src=https://image.pseudoyu.com/images/hardhat_verify_contract_etherscan.png alt=hardhat_verify_contract_etherscan></p><p><img src=https://image.pseudoyu.com/images/verified_contract_on_etherscan.png alt=verified_contract_on_etherscan></p><p>我们通过 Etherscan 验证后访问后可以直接查看合约源码并进行交互。</p><p><img src=https://image.pseudoyu.com/images/interact_with_contract_on_etherscan.png alt=interact_with_contract_on_etherscan></p><h3 id=合约测试>合约测试</h3><p>对于智能合约来说，其大多数操作都需要部署上链，与资产交互，消耗 gas，且一旦有安全隐患会造成严重的后果。因此，我们需要对智能合约进行详细的测试。</p><p>Hardhat 提供了完备的测试调试工具，可以在 <code>tests</code> 目录中编写测试脚本，通过 <code>yarn hardhat test</code> 命令运行测试。</p><h4 id=编写测试脚本>编写测试脚本</h4><p>为我们的部署脚本编写 <code>test-deploy.js</code> 测试程序，首先需要导入必要包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>assert</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;chai&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>ethers</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;hardhat&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>然后编写测试逻辑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;SimpleStorage&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>simpleStorageFactory</span><span class=p>,</span> <span class=nx>simpleStorage</span>
</span></span><span class=line><span class=cl>    <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>simpleStorageFactory</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>ethers</span><span class=p>.</span><span class=nx>getContractFactory</span><span class=p>(</span><span class=s2>&#34;SimpleStorage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>simpleStorage</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>simpleStorageFactory</span><span class=p>.</span><span class=nx>deploy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;Should start with a favorite number of 0&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>currentValue</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>retrieve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>expectedValue</span> <span class=o>=</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>currentValue</span><span class=p>.</span><span class=nx>toString</span><span class=p>(),</span> <span class=nx>expectedValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// expect(currentValue.toString()).to.equal(expectedValue)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;Should update when we call store&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>expectedValue</span> <span class=o>=</span> <span class=s2>&#34;7&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>transactionRespense</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>store</span><span class=p>(</span><span class=nx>expectedValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>transactionRespense</span><span class=p>.</span><span class=nx>wait</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>currentValue</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>simpleStorage</span><span class=p>.</span><span class=nx>retrieve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>currentValue</span><span class=p>.</span><span class=nx>toString</span><span class=p>(),</span> <span class=nx>expectedValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// expect(currentValue.toString()).to.equal(expectedValue)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span></code></pre></div><p>在 Hardhat 的测试脚本中，我们使用 <code>describe</code> 包裹测试类，并且使用 <code>it</code> 包裹测试方法。我们需要保证测试前合约已经部署，因此，我们通过 <code>beforeEach</code> 方法在每个测试方法执行前都会调用 <code>simpleStorageFactory.deploy()</code>，并且将返回的 <code>simpleStorage</code> 对象赋值给 <code>simpleStorage</code> 变量。</p><p>我们使用 <code>assert.equal(currentValue.toString(), expectedValue)</code> 来对执行结果与预期结果进行比照，可以用 <code>expect(currentValue.toString()).to.equal(expectedValue)</code> 替代，效果一样。</p><p>此外，我们还可以通过 <code>it.only()</code> 来指定仅执行其中一个测试方法。</p><h4 id=执行测试脚本>执行测试脚本</h4><p>我们通过 <code>yarn hardhat test</code> 运行测试，且可以通过 <code>yarn hardhat test --grep store</code> 来指定测试方法。</p><p><img src=https://image.pseudoyu.com/images/hardhat_run_tests.png alt=hardhat_run_tests></p><h3 id=添加-gas-reporter-支持>添加 <code>gas-reporter</code> 支持</h3><p>如上文所述，gas 是我们在开发过程中需要特别关注的资源，尤其在 Ethereum 主网上尤其昂贵。因此，我们需要在测试过程中查看 gas 消耗情况。HardHat 也有一个 <code>gas-reporter</code> 插件，可以很方便地输出 gas 消耗情况。</p><h4 id=安装-gas-reporter-插件>安装 <code>gas-reporter</code> 插件</h4><p>我们通过 <code>yarn add --dev hardhat-gas-reporter</code> 命令来安装插件：</p><p><img src=https://image.pseudoyu.com/images/yarn_add_gas_reporter.png alt=yarn_add_gas_reporter></p><h4 id=启用-gas-reporter-支持>启用 <code>gas-reporter</code> 支持</h4><p>我们通过在 <code>hardhat.config.js</code> 中添加 <code>gasReporter: true</code> 及额外配置项来启用插件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;hardhat-gas-reporter&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>COINMARKETCAP_API_KEY</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>COINMARKETCAP_API_KEY</span> <span class=o>||</span> <span class=s2>&#34;key&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>gasReporter</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>enabled</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>outputFile</span><span class=o>:</span> <span class=s2>&#34;gas-reporter.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>noColors</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>currency</span><span class=o>:</span> <span class=s2>&#34;USD&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>coinmarketcap</span><span class=o>:</span> <span class=nx>COINMARKETCAP_API_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>token</span><span class=o>:</span> <span class=s2>&#34;MATIC&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们可以指定输出文件、是否开启颜色、指定币种、指定代币名称，以及指定代币的 CoinMarketCap API 密钥来根据项目进一步控制输出。</p><p>按照以上配置，运行 <code>yarn hardhat test</code> 输出效果如下：</p><p><img src=https://image.pseudoyu.com/images/hardhat_add_gas_reporter_support_and_export.png alt=hardhat_add_gas_reporter_support_and_export></p><h3 id=添加-solidity-coverage-支持>添加 <code>solidity-coverage</code> 支持</h3><p>合约测试对于保障业务逻辑正确性与安全防范至关重要，因此，我们需要对合约进行覆盖率测试。HardHat 也有一个 <code>solidity-coverage</code> 插件，可以很方便地输出覆盖率情况。</p><h4 id=安装-solidity-coverage-插件>安装 <code>solidity-coverage</code> 插件</h4><p>我们通过 <code>yarn add --dev solidity-coverage</code> 命令来安装插件：</p><p><img src=https://image.pseudoyu.com/images/yarn_add_coverage_support.png alt=yarn_add_coverage_support></p><h4 id=启用-solidity-coverage-支持>启用 <code>solidity-coverage</code> 支持</h4><p>我们仅需在 <code>hardhat.config.js</code> 中导入包即可添加覆盖率测试支持：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;solidity-coverage&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=运行覆盖率测试>运行覆盖率测试</h4><p>通过 <code>yarn hardhat coverage</code> 即可运行覆盖率测试：</p><p><img src=https://image.pseudoyu.com/images/hardhat_coverage.png alt=hardhat_coverage></p><h3 id=task>Task</h3><p>上文我们对 <code>hardhat</code> 库的基础功能与脚本进行了一些使用。除此之外，我们还可以自定义一些任务供开发调试使用。</p><h4 id=编写-task>编写 Task</h4><p>Hardhat 中，我们将任务定义在 <code>tasks</code> 目录下，我们将编写一个 <code>block-number.js</code> 的 Task 来获取区块高度：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>task</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;hardhat/config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>task</span><span class=p>(</span><span class=s2>&#34;block-number&#34;</span><span class=p>,</span> <span class=s2>&#34;Prints the current block number&#34;</span><span class=p>).</span><span class=nx>setAction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=p>(</span><span class=nx>taskArgs</span><span class=p>,</span> <span class=nx>hre</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>blockNumber</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>hre</span><span class=p>.</span><span class=nx>ethers</span><span class=p>.</span><span class=nx>provider</span><span class=p>.</span><span class=nx>getBlockNumber</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Current Block Number: </span><span class=si>${</span><span class=nx>blockNumber</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>Task 通过 <code>task()</code> 方法来创建，并通过 <code>setAction()</code> 方法来设置任务的执行函数。其中，<code>taskArgs</code> 是一个包含所有参数的对象，<code>hre</code> 是一个 <code>HardhatRuntimeEnvironment</code> 对象，可以用来获取其他的资源。</p><h4 id=运行-task>运行 Task</h4><p>定义完成后，在项目命令的 <code>AVAILABLE TASKS</code> 中就有了我们刚定义好的 <code>block-number</code> 任务，可以通过 <code>yarn hardhat block-number</code> 命令来运行任务，同样的，我们可以指定特定网络运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn hardhat block-number --network rinkeby
</span></span></code></pre></div><p><img src=https://image.pseudoyu.com/images/hardhat_run_tasks.png alt=hardhat_run_tasks></p><h3 id=hardhat-console>Hardhat Console</h3><p>最后，除了通过代码与链/合约进行交互外，我们还可以通过 <code>Hardhat Console</code> 来调试项目，查看链状态，合约的输入、输出等。我们可以通过 <code>yarn hardhat console</code> 命令来打开 Hardhat Console，并进行交互。</p><p><img src=https://image.pseudoyu.com/images/hardhat_console.png alt=hardhat_console></p><h2 id=总结>总结</h2><p>以上就是我对 Hardhat 框架的基础配置与使用，它是一个很强大的开发框架，我后续还将会继续深入了解它的更多特性与使用技巧，如果有兴趣，可以继续关注，希望对大家有所帮助。</p><h2 id=参考资料>参考资料</h2><blockquote><ol><li><a href="https://www.youtube.com/watch?v=gyMwXuJrbJQ">Learn Blockchain, Solidity, and Full Stack Web3 Development with JavaScript</a></li><li><a href=https://github.com/NomicFoundation/hardhat>NomicFoundation/hardhat</a></li><li><a href=https://hardhat.org/getting-started>Hardhat 官方文档</a></li><li><a href=https://www.pseudoyu.com/en/2022/05/25/learn_solidity_from_scratch_basic/>Solidity 智能合约开发 - 基础</a></li><li><a href=https://www.pseudoyu.com/en/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity 智能合约开发 - 玩转 Web3.py</a></li><li><a href=https://www.pseudoyu.com/en/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></li></ol></blockquote></articl><h2>Related Posts</h2><dl class=row></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-09-13</dt><dd class=col-md-9><a href=/en/2023/09/13/weekly_review_20230913/>周报 #46 - 告别长发、周报初心与合约开发</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2023-04-30</dt><dd class=col-md-9><a href=/en/2023/04/30/weekly_review_20230430/>周报 #38 - Foundry 合约测试、Logseq 任务管理与 Surge Ponte 远程开发</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-07-01</dt><dd class=col-md-9><a href=/en/2022/07/01/two_phase_commit_contract_practice_in_solidity/>通过状态锁在 Solidity 智能合约中实现两阶段提交</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-06-08</dt><dd class=col-md-9><a href=/en/2022/06/08/learn_solidity_from_scratch_ethersjs/>Solidity 智能合约开发 - 玩转 ethers.js</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl><dt class=col-md-3>2022-05-30</dt><dd class=col-md-9><a href=/en/2022/05/30/learn_solidity_from_scratch_web3py/>Solidity 智能合约开发 - 玩转 Web3.py</a></dd></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://www.pseudoyu.com><img src=/images/author.webp alt=pseudoyu></a></div><div class=author-content><p class=author-title>Author</p><p class=author-name>pseudoyu</p><p class=author-desc>Backend & Smart Contract Developer, MSc Graduate in ECIC(Electronic Commerce and Internet Computing) @ The University of Hong Kong (HKU). Love to learn and build things. <a href=https://github.com/pseudoyu>Follow me on GitHub</a></p></div></div></div><div align=center><div class=comment-underline></div></div><br><div id=cusdis_thread data-host=https://comments.pseudoyu.com data-app-id=27a61667-fd43-4a0d-934d-f45b944489ee data-page-id=57ca604e2bba11fd70217832c3223fea data-page-url=https://www.pseudoyu.com/en/2022/06/09/learn_solidity_from_scratch_hardhat/ data-page-title="Solidity 智能合约开发 - Hardhat 框架使用"></div><script defer src=https://comments.pseudoyu.com/js/widget/lang/zh-cn.js></script>
<script async defer src=https://comments.pseudoyu.com/js/cusdis.es.js></script>
<script defer data-host=https://comments.pseudoyu.com data-app-id=27a61667-fd43-4a0d-934d-f45b944489ee src=https://comments.pseudoyu.com/js/cusdis-count.umd.js></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Sitemap</div><ul class=list-unstyled><li><a href=https://www.pseudoyu.com/en/tags/>Tags</a></li><li><a href=https://www.pseudoyu.com/en/categories/>Categories</a></li><li><a rel=alternate type=application/rss+xml href=https://www.pseudoyu.com/en/index.xml><i class="fas fa-rss-square"></i> RSS Feed</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Social</div><ul class=list-unstyled><li><a href=https://t.me/pseudoyulife rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/pseudo_yu rel=noopener target=_blank>Twitter</a></li><li><a href=https://www.instagram.com/pseudo.yu/ rel=noopener target=_blank>Instagram</a></li><li><a href=https://space.bilibili.com/5374948/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>Links</div><ul class=list-unstyled><li><a href=https://github.com/pseudoyu rel=noopener target=_blank>Yu's GitHub</a></li><li><a href=https://uptime.pseudoyu.com/status/services rel=noopener target=_blank>Yu's Services</a></li><li><a href=https://www.m1sty.com/ rel=noopener target=_blank>M1sty's Blog</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em><a href=https://data.pseudoyu.com/share/8YKX7FUa/pseudoyu-blog rel=noopener target=_blank>Yu's blog analytics</a></em></small><br><small><em>Powered by <a href=https://gohugo.io rel=noopener target=_blank>Hugo</a> - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>den</a></em></small><br><small><em><a href=https://www.hku.hk rel=noopener target=_blank>The University of Hong Kong</a> - <a href=https://www.cs.hku.hk rel=noopener target=_blank>CS</a></em></small><br><small>&copy;
Yu Zhang
2020 -
2023</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script></body></html>